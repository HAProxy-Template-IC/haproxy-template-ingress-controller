Please review the changes in this branch thoroughly regarding bugs, violations of the DRY principe and code smells.