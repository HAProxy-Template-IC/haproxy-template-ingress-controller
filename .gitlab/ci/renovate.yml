spec:
  inputs:
    rotate_renovate_token:
      type: boolean
      default: false
      description: "Set to true to rotate the Renovate access token"
---

# Renovate dependency update automation
# Runs on schedule to check for dependency updates and create MRs

include:
  - project: 'renovate-bot/renovate-runner'
    file: '/templates/renovate.gitlab-ci.yml'

renovate:
  rules:
    - if: '"$[[ inputs.rotate_renovate_token ]]" == "true"'
      when: never
    - if: $CI_PIPELINE_SOURCE == "schedule"
    - if: $CI_PIPELINE_SOURCE == "web"
  variables:
    RENOVATE_EXTRA_FLAGS: '--autodiscover=false'

# Automatic token rotation to prevent expiration
# Runs monthly via scheduled pipeline with rotate_renovate_token input=true
rotate-renovate-token:
  stage: .pre
  image: curlimages/curl:latest
  rules:
    - if: '"$[[ inputs.rotate_renovate_token ]]" == "true"'
  script:
    - |
      # Rotate the token via GitLab API (preserves bot user identity)
      NEW_TOKEN=$(curl --silent --fail --request POST \
        --header "PRIVATE-TOKEN: ${RENOVATE_TOKEN}" \
        "${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/access_tokens/self/rotate" \
        | jq -r '.token')

      if [ -z "$NEW_TOKEN" ] || [ "$NEW_TOKEN" = "null" ]; then
        echo "ERROR: Failed to rotate token"
        exit 1
      fi

      # Update the CI/CD variable with the new token
      curl --silent --fail --request PUT \
        --header "PRIVATE-TOKEN: ${NEW_TOKEN}" \
        "${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/variables/RENOVATE_TOKEN" \
        --form "value=${NEW_TOKEN}" \
        --form "masked=true"

      echo "Token rotated successfully"
