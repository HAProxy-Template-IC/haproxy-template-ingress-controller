{{- if .Values.haproxy.enabled }}
apiVersion: apps/v1
kind: Deployment
metadata:
  name: {{ include "haptic.fullname" . }}-haproxy
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "haptic.labels" . | nindent 4 }}
    app.kubernetes.io/component: loadbalancer
    {{- with .Values.commonLabels }}
    {{- toYaml . | nindent 4 }}
    {{- end }}
  {{- with .Values.commonAnnotations }}
  annotations:
    {{- toYaml . | nindent 4 }}
  {{- end }}
spec:
  {{- if not .Values.haproxy.keda.enabled }}
  replicas: {{ .Values.haproxy.replicaCount }}
  {{- end }}
  {{- with .Values.haproxy.updateStrategy }}
  strategy:
    {{- toYaml . | nindent 4 }}
  {{- end }}
  minReadySeconds: {{ .Values.haproxy.minReadySeconds }}
  revisionHistoryLimit: {{ .Values.haproxy.revisionHistoryLimit }}
  selector:
    matchLabels:
      {{- include "haptic.selectorLabels" . | nindent 6 }}
      app.kubernetes.io/component: loadbalancer
  template:
    metadata:
      labels:
        {{- include "haptic.selectorLabels" . | nindent 8 }}
        {{- include "haptic.componentLabels" "loadbalancer" | nindent 8 }}
    spec:
      {{- with .Values.haproxy.priorityClassName }}
      priorityClassName: {{ . }}
      {{- end }}
      terminationGracePeriodSeconds: {{ .Values.haproxy.terminationGracePeriodSeconds }}
      {{- with .Values.haproxy.nodeSelector }}
      nodeSelector:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      {{- with .Values.haproxy.affinity }}
      affinity:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      {{- with .Values.haproxy.tolerations }}
      tolerations:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      {{- with .Values.haproxy.topologySpreadConstraints }}
      topologySpreadConstraints:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      dnsPolicy: {{ .Values.haproxy.dnsPolicy }}
      {{- with .Values.haproxy.dnsConfig }}
      dnsConfig:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      {{- with .Values.haproxy.hostAliases }}
      hostAliases:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      {{- with .Values.haproxy.runtimeClassName }}
      runtimeClassName: {{ . }}
      {{- end }}
      {{- with .Values.haproxy.initContainers }}
      initContainers:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      securityContext:
        runAsNonRoot: true
        runAsUser: {{ include "haptic.haproxy.runAsUser" . }}
        runAsGroup: {{ include "haptic.haproxy.runAsGroup" . }}
        fsGroup: {{ include "haptic.haproxy.fsGroup" . }}
        {{- with .Values.haproxy.podSecurityContext.seccompProfile }}
        seccompProfile:
          {{- toYaml . | nindent 10 }}
        {{- end }}
      containers:
        # HAProxy container
        - name: haproxy
          securityContext:
            allowPrivilegeEscalation: false
            capabilities:
              drop: [ALL]
              {{- if .Values.haproxy.enterprise.enabled }}
              # Enterprise binaries have file capabilities requiring NET_BIND_SERVICE
              # PSS Restricted profile allows this capability
              add: [NET_BIND_SERVICE]
              {{- end }}
            runAsNonRoot: true
            runAsUser: {{ include "haptic.haproxy.runAsUser" . }}
          image: {{ include "haptic.haproxy.image" . }}
          imagePullPolicy: {{ .Values.haproxy.image.pullPolicy }}
          command: ["/bin/sh", "-c"]
          args:
            - |
              # Create required directories
              # Note: fsGroup handles ownership - no chown needed (and CAP_CHOWN is dropped)
              mkdir -p /etc/haproxy/maps /etc/haproxy/certs /etc/haproxy/errors /etc/haproxy/general

              # Copy initial config
              cp /config/haproxy.cfg /etc/haproxy/haproxy.cfg

              # Start HAProxy in master-worker mode with master socket
              # -dr: Skip DNS resolution failures - servers start in DOWN state instead of failing startup
              exec {{ include "haptic.haproxy.bin" . }} -dr -W -db -S "/etc/haproxy/haproxy-master.sock,level,admin" -- /etc/haproxy/haproxy.cfg
          ports:
            - name: http
              containerPort: {{ .Values.haproxy.ports.http }}
              protocol: TCP
            - name: https
              containerPort: {{ .Values.haproxy.ports.https }}
              protocol: TCP
            - name: stats
              containerPort: {{ .Values.haproxy.ports.stats }}
              protocol: TCP
          volumeMounts:
            - name: config
              mountPath: /config
            - name: haproxy-runtime
              mountPath: /etc/haproxy
            {{- with .Values.haproxy.extraVolumeMounts }}
            {{- toYaml . | nindent 12 }}
            {{- end }}
          livenessProbe:
            httpGet:
              path: /healthz
              port: stats
            initialDelaySeconds: 10
            periodSeconds: 10
          readinessProbe:
            httpGet:
              path: /ready
              port: stats
            initialDelaySeconds: 5
            periodSeconds: 5
          {{- with .Values.haproxy.lifecycle }}
          lifecycle:
            {{- toYaml . | nindent 12 }}
          {{- end }}
          resources:
            {{- toYaml .Values.haproxy.resources | nindent 12 }}

        # Dataplane API sidecar
        - name: dataplane
          securityContext:
            allowPrivilegeEscalation: false
            capabilities:
              drop: [ALL]
              {{- if .Values.haproxy.enterprise.enabled }}
              # Enterprise: dataplaneapi calls HAProxy binary which has file capabilities
              # PSS Restricted profile allows this capability
              add: [NET_BIND_SERVICE]
              {{- end }}
            readOnlyRootFilesystem: true
            runAsNonRoot: true
            runAsUser: {{ include "haptic.haproxy.dataplaneRunAsUser" . }}
          image: {{ include "haptic.haproxy.image" . }}
          imagePullPolicy: {{ .Values.haproxy.image.pullPolicy }}
          command: ["/bin/sh", "-c"]
          args:
            - |
              # Wait for HAProxy to create the socket
              while [ ! -S /etc/haproxy/haproxy-master.sock ]; do
                echo "Waiting for HAProxy master socket..."
                sleep 1
              done

              # Create required directories
              # Note: Directories owned by user 99 via pod fsGroup, no chown needed
              mkdir -p /var/lib/dataplaneapi/transactions /var/lib/dataplaneapi/backups
              mkdir -p /etc/haproxy/maps /etc/haproxy/certs /etc/haproxy/general

              # Create Dataplane API config
              cat > /etc/haproxy/dataplaneapi.yaml <<'EOF'
              config_version: 2
              name: haproxy-dataplaneapi
              dataplaneapi:
                host: 0.0.0.0
                port: {{ .Values.haproxy.ports.dataplane }}
                disable_inotify: true
                user:
                  - name: {{ .Values.haproxy.dataplane.credentials.username }}
                    password: {{ .Values.haproxy.dataplane.credentials.password }}
                    insecure: true
                transaction:
                  transaction_dir: /var/lib/dataplaneapi/transactions
                  backups_number: 10
                  backups_dir: /var/lib/dataplaneapi/backups
                resources:
                  maps_dir: {{ .Values.controller.config.dataplane.mapsDir }}
                  ssl_certs_dir: {{ .Values.controller.config.dataplane.sslCertsDir }}
                  general_storage_dir: {{ .Values.controller.config.dataplane.generalStorageDir }}
              haproxy:
                config_file: {{ .Values.controller.config.dataplane.configFile }}
                haproxy_bin: {{ include "haptic.haproxy.bin" . }}
                # validate_cmd: Use -dr to skip DNS resolution failures during config validation
                # This prevents config rejection when DNS is temporarily unavailable
                validate_cmd: {{ include "haptic.haproxy.bin" . }} -dr -c -f %s
                master_worker_mode: true
                master_runtime: /etc/haproxy/haproxy-master.sock
                reload:
                  reload_delay: 1
                  reload_cmd: /bin/sh -c "echo 'reload' | socat stdio unix-connect:/etc/haproxy/haproxy-master.sock"
                  restart_cmd: /bin/sh -c "echo 'reload' | socat stdio unix-connect:/etc/haproxy/haproxy-master.sock"
                  reload_strategy: custom
              log_targets:
                - log_to: stdout
                  log_level: trace
                  log_types:
                  - access
                  - app
              EOF

              # Start Dataplane API
              exec {{ include "haptic.haproxy.dataplanebin" . }} -f /etc/haproxy/dataplaneapi.yaml
          ports:
            - name: dataplane
              containerPort: {{ .Values.haproxy.ports.dataplane }}
              protocol: TCP
          volumeMounts:
            - name: haproxy-runtime
              mountPath: /etc/haproxy
            - name: dataplane-data
              mountPath: /var/lib/dataplaneapi
            - name: dataplane-tmp
              mountPath: /tmp
          livenessProbe:
            httpGet:
              path: /v3/info
              port: dataplane
              httpHeaders:
                - name: Authorization
                  value: "Basic {{ printf "%s:%s" .Values.haproxy.dataplane.credentials.username .Values.haproxy.dataplane.credentials.password | b64enc }}"
            initialDelaySeconds: 15
            periodSeconds: 10
          readinessProbe:
            httpGet:
              path: /v3/info
              port: dataplane
              httpHeaders:
                - name: Authorization
                  value: "Basic {{ printf "%s:%s" .Values.haproxy.dataplane.credentials.username .Values.haproxy.dataplane.credentials.password | b64enc }}"
            initialDelaySeconds: 10
            periodSeconds: 5

        {{- with .Values.haproxy.sidecars }}
        {{- toYaml . | nindent 8 }}
        {{- end }}
      volumes:
        - name: config
          configMap:
            name: {{ include "haptic.fullname" . }}-haproxy-config
        - name: haproxy-runtime
          emptyDir: {}
        - name: dataplane-data
          emptyDir: {}
        - name: dataplane-tmp
          emptyDir: {}
        {{- with .Values.haproxy.extraVolumes }}
        {{- toYaml . | nindent 8 }}
        {{- end }}
{{- end }}
