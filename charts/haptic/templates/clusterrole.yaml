{{- if .Values.rbac.create }}
{{- /* Merge watched resources from libraries */ -}}
{{- $mergedLibraries := include "haptic.mergeLibraries" . | fromYaml }}
{{- $allWatchedResources := merge ($mergedLibraries.watchedResources | default dict) (.Values.controller.config.watchedResources | default dict) }}
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: {{ include "haptic.fullname" . }}
  labels:
    {{- include "haptic.labels" . | nindent 4 }}
rules:
  # Watched resources from configuration and libraries
  {{- range $name, $resource := $allWatchedResources }}
  - apiGroups:
      {{- if eq $resource.apiVersion "v1" }}
      - ""
      {{- else }}
      - {{ $resource.apiVersion | regexFind "^[^/]+" }}
      {{- end }}
    resources:
      - {{ $resource.resources }}
    verbs: ["get", "list", "watch"]
  {{- end }}
  # Additional core resources
  - apiGroups: [""]
    resources: ["namespaces", "pods"]
    verbs: ["get", "list", "watch"]
  # Leader election (coordination.k8s.io/v1)
  - apiGroups: ["coordination.k8s.io"]
    resources: ["leases"]
    verbs: ["get", "create", "update"]
  # HAProxyTemplateConfig CRD
  - apiGroups: ["haproxy-haptic.org"]
    resources: ["haproxytemplateconfigs"]
    verbs: ["get", "list", "watch"]
  # HAProxyTemplateConfig status updates
  - apiGroups: ["haproxy-haptic.org"]
    resources: ["haproxytemplateconfigs/status"]
    verbs: ["update", "patch"]
  # Auxiliary file CRDs for config publishing
  - apiGroups: ["haproxy-haptic.org"]
    resources: ["haproxycfgs", "haproxygeneralfiles", "haproxycrtlistfiles", "haproxymapfiles"]
    verbs: ["get", "list", "watch", "create", "update", "patch", "delete"]
  # Auxiliary file CRD status updates
  - apiGroups: ["haproxy-haptic.org"]
    resources: ["haproxycfgs/status", "haproxygeneralfiles/status", "haproxycrtlistfiles/status", "haproxymapfiles/status"]
    verbs: ["update", "patch"]
{{- end }}
