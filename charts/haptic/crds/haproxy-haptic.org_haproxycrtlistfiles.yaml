---
apiVersion: apiextensions.k8s.io/v1
kind: CustomResourceDefinition
metadata:
  annotations:
    controller-gen.kubebuilder.io/version: v0.20.0
  name: haproxycrtlistfiles.haproxy-haptic.org
spec:
  group: haproxy-haptic.org
  names:
    kind: HAProxyCRTListFile
    listKind: HAProxyCRTListFileList
    plural: haproxycrtlistfiles
    shortNames:
    - hpcl
    singular: haproxycrtlistfile
  scope: Namespaced
  versions:
  - additionalPrinterColumns:
    - jsonPath: .spec.listName
      name: List Name
      type: string
    - jsonPath: .spec.path
      name: Path
      type: string
    - jsonPath: .metadata.creationTimestamp
      name: Age
      type: date
    name: v1alpha1
    schema:
      openAPIV3Schema:
        description: |-
          HAProxyCRTListFile contains a rendered HAProxy crt-list file.

          CRT-list files contain SSL certificate references with per-certificate options
          and SNI filters. This is a read-only resource automatically created and updated
          by the controller. Each HAProxyCRTListFile is owned by a HAProxyCfg resource.
        properties:
          apiVersion:
            description: |-
              APIVersion defines the versioned schema of this representation of an object.
              Servers should convert recognized schemas to the latest internal value, and
              may reject unrecognized values.
              More info: https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#resources
            type: string
          kind:
            description: |-
              Kind is a string value representing the REST resource this object represents.
              Servers may infer this from the endpoint the client submits requests to.
              Cannot be updated.
              In CamelCase.
              More info: https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#types-kinds
            type: string
          metadata:
            type: object
          spec:
            description: HAProxyCRTListFileSpec contains the crt-list file content.
            properties:
              checksum:
                description: |-
                  Checksum is the SHA-256 hash of the crt-list entries.

                  Used to detect changes and verify consistency across pods.
                  Format: sha256:<hex-digest>
                minLength: 1
                type: string
              compressed:
                description: |-
                  Compressed indicates the entries are zstd+base64 encoded.

                  When true, consumers must decompress before use.
                type: boolean
              entries:
                description: |-
                  Entries is the crt-list file content.

                  Each line contains a certificate path with optional SSL options and SNI filters.
                  Format: <cert-path> [ssl-options] [sni-filter]
                  Example:
                    /etc/haproxy/ssl/example.com.pem [ocsp-update on] example.com
                    /etc/haproxy/ssl/wildcard.pem *.example.org
                minLength: 1
                type: string
              listName:
                description: |-
                  ListName is the logical name of the crt-list file.

                  Example: "frontend-certs" or "backend-client-certs"
                minLength: 1
                type: string
              path:
                description: |-
                  Path is the file system path where this crt-list file is stored.

                  Example: /etc/haproxy/crt-lists/frontend.crtlist
                minLength: 1
                type: string
            required:
            - checksum
            - entries
            - listName
            - path
            type: object
          status:
            description: HAProxyCRTListFileStatus tracks deployment state to HAProxy
              pods.
            properties:
              conditions:
                description: |-
                  Conditions represent the latest available observations of the resource's state.

                  Standard conditions include:
                  - "Synced": CRT-list file has been successfully applied to all target pods
                  - "Ready": Resource is ready for use
                items:
                  description: Condition contains details for one aspect of the current
                    state of this API Resource.
                  properties:
                    lastTransitionTime:
                      description: |-
                        lastTransitionTime is the last time the condition transitioned from one status to another.
                        This should be when the underlying condition changed.  If that is not known, then using the time when the API field changed is acceptable.
                      format: date-time
                      type: string
                    message:
                      description: |-
                        message is a human readable message indicating details about the transition.
                        This may be an empty string.
                      maxLength: 32768
                      type: string
                    observedGeneration:
                      description: |-
                        observedGeneration represents the .metadata.generation that the condition was set based upon.
                        For instance, if .metadata.generation is currently 12, but the .status.conditions[x].observedGeneration is 9, the condition is out of date
                        with respect to the current state of the instance.
                      format: int64
                      minimum: 0
                      type: integer
                    reason:
                      description: |-
                        reason contains a programmatic identifier indicating the reason for the condition's last transition.
                        Producers of specific condition types may define expected values and meanings for this field,
                        and whether the values are considered a guaranteed API.
                        The value should be a CamelCase string.
                        This field may not be empty.
                      maxLength: 1024
                      minLength: 1
                      pattern: ^[A-Za-z]([A-Za-z0-9_,:]*[A-Za-z0-9_])?$
                      type: string
                    status:
                      description: status of the condition, one of True, False, Unknown.
                      enum:
                      - "True"
                      - "False"
                      - Unknown
                      type: string
                    type:
                      description: type of condition in CamelCase or in foo.example.com/CamelCase.
                      maxLength: 316
                      pattern: ^([a-z0-9]([-a-z0-9]*[a-z0-9])?(\.[a-z0-9]([-a-z0-9]*[a-z0-9])?)*/)?(([A-Za-z0-9][-A-Za-z0-9_.]*)?[A-Za-z0-9])$
                      type: string
                  required:
                  - lastTransitionTime
                  - message
                  - reason
                  - status
                  - type
                  type: object
                type: array
                x-kubernetes-list-map-keys:
                - type
                x-kubernetes-list-type: map
              deployedToPods:
                description: |-
                  DeployedToPods tracks which HAProxy pods currently have this crt-list file.

                  Pods are automatically added when the crt-list file is applied and removed when
                  the pod terminates.
                items:
                  description: PodDeploymentStatus tracks deployment to a specific
                    pod.
                  properties:
                    checksum:
                      description: Checksum of the configuration deployed to this
                        pod.
                      type: string
                    consecutiveErrors:
                      description: |-
                        ConsecutiveErrors is the count of consecutive sync failures.

                        This counter increments on each failure and resets to 0 on success.
                        High values indicate persistent problems requiring investigation.
                      minimum: 0
                      type: integer
                    deployedAt:
                      description: |-
                        DeployedAt is the timestamp when configuration was last successfully
                        synchronized to this pod.

                        Updated when actual operations are performed (TotalOperations > 0) or when
                        drift prevention verifies configuration matches expected state.
                      format: date-time
                      type: string
                    fallbackUsed:
                      description: |-
                        FallbackUsed indicates whether the last sync used fallback mode.

                        When true, indicates that incremental sync failed and a full raw configuration
                        push was used instead. Frequent fallbacks may indicate sync logic issues.
                      type: boolean
                    lastError:
                      description: |-
                        LastError contains the error message from the most recent failed sync attempt.

                        This field is cleared when a sync succeeds. Combined with ConsecutiveErrors,
                        this helps identify persistent vs transient issues.
                      type: string
                    lastErrorAt:
                      description: |-
                        LastErrorAt is the timestamp of the most recent sync error.

                        Used to determine how long a pod has been in an error state.
                      format: date-time
                      type: string
                    lastOperationSummary:
                      description: |-
                        LastOperationSummary provides a breakdown of operations performed in the last sync.

                        This shows the number of backends, servers, and other resources that were
                        added, removed, or modified during synchronization.
                      properties:
                        backendsAdded:
                          description: BackendsAdded is the number of backends added.
                          minimum: 0
                          type: integer
                        backendsModified:
                          description: BackendsModified is the number of backends
                            modified.
                          minimum: 0
                          type: integer
                        backendsRemoved:
                          description: BackendsRemoved is the number of backends removed.
                          minimum: 0
                          type: integer
                        frontendsAdded:
                          description: FrontendsAdded is the number of frontends added.
                          minimum: 0
                          type: integer
                        frontendsModified:
                          description: FrontendsModified is the number of frontends
                            modified.
                          minimum: 0
                          type: integer
                        frontendsRemoved:
                          description: FrontendsRemoved is the number of frontends
                            removed.
                          minimum: 0
                          type: integer
                        serversAdded:
                          description: ServersAdded is the number of servers added
                            across all backends.
                          minimum: 0
                          type: integer
                        serversModified:
                          description: ServersModified is the number of servers modified
                            across all backends.
                          minimum: 0
                          type: integer
                        serversRemoved:
                          description: ServersRemoved is the number of servers removed
                            across all backends.
                          minimum: 0
                          type: integer
                        totalAPIOperations:
                          description: |-
                            TotalAPIOperations is the total count of HAProxy Dataplane API operations
                            across ALL configuration sections (includes globals, defaults, acls, binds, etc.).

                            This may be higher than the sum of specific operations shown below, as it includes
                            operations on sections not individually tracked in this summary.
                          minimum: 0
                          type: integer
                      type: object
                    lastReloadAt:
                      description: |-
                        LastReloadAt is the timestamp when HAProxy was last reloaded for this pod.

                        HAProxy reloads occur when structural configuration changes are made via
                        the transaction API (status 202). Runtime-only changes do not trigger reloads.
                      format: date-time
                      type: string
                    lastReloadID:
                      description: |-
                        LastReloadID is the reload identifier from the most recent HAProxy reload.

                        This corresponds to the Reload-ID header returned by the HAProxy dataplane
                        API when a reload is triggered.
                      type: string
                    podName:
                      description: PodName is the name of the HAProxy pod.
                      minLength: 1
                      type: string
                    syncDuration:
                      description: |-
                        SyncDuration is the duration of the most recent sync operation.

                        This tracks how long it took to apply configuration changes to this pod,
                        useful for performance monitoring and troubleshooting.
                      type: string
                    versionConflictRetries:
                      description: |-
                        VersionConflictRetries is the number of version conflict retries during the last sync.

                        HAProxy's dataplane API uses optimistic concurrency control. This counter
                        tracks retries due to version conflicts, indicating contention or race conditions.
                      minimum: 0
                      type: integer
                  required:
                  - deployedAt
                  - podName
                  type: object
                type: array
              observedGeneration:
                description: |-
                  ObservedGeneration reflects the generation of the spec that was most recently processed.

                  This is used to track whether status is up-to-date with latest spec changes.
                format: int64
                type: integer
            type: object
        type: object
    served: true
    storage: true
    subresources:
      status: {}
