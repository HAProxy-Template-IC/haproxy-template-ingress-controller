# HAProxy Ingress compatibility library for HAPTIC
# Provides support for haproxy-ingress.github.io annotation compatibility
# Reference: https://haproxy-ingress.github.io/docs/configuration/keys/
#
# Supported annotations:
# - haproxy-ingress.github.io/path-type: "regex"
#
# Note: This library only implements regex path matching. Other path-type values
# (exact, prefix, begin) are handled by the standard Ingress pathType field or
# require additional implementation.

templateSnippets:
  map-path-regex-600-haproxy-ingress:
    template: |
      {#-
        HAProxy Ingress Regex Path Map Entries

        Purpose: Generates path-regex.map entries for Ingress resources with
                 haproxy-ingress.github.io/path-type: "regex" annotation.

        Extension Point: map-path-regex-* (priority 600 - compatibility layer)

        Matches: Ingress paths with:
          - pathType: ImplementationSpecific
          - Annotation: haproxy-ingress.github.io/path-type: "regex"

        Reference: https://haproxy-ingress.github.io/docs/configuration/keys/
      -#}
      {%- var isFirst = true %}
      {%- for _, ingress := range resources.ingresses.List() %}
      {%- var pathTypeAnnotation = ingress | dig("metadata", "annotations", "haproxy-ingress.github.io/path-type") | fallback("") %}
      {%- if pathTypeAnnotation == "regex" -%}
      {%- if isFirst %}
      # haproxy-ingress/map-path-regex-haproxy-ingress
      {%- isFirst = false %}
      {%- end %}
      {#- Count regex paths for this ingress -#}
      {%- var allPaths = []any{} %}
      {%- var rules = ingress | dig("spec", "rules") | fallback([]any{}) %}
      {%- for _, rule := range rules %}
      {%- var http = rule | dig("http") %}
      {%- if http != nil %}
        {%- var paths = http | dig("paths") | fallback([]any{}) %}
        {%- for _, path := range paths %}
        {%- if path | dig("pathType") == "ImplementationSpecific" %}
          {%- allPaths = append(allPaths, path) %}
        {%- end %}
        {%- end %}
      {%- end %}
      {%- end %}
      {%- if len(allPaths) > 0 %}
      # Ingress: {{ ingress | dig("metadata", "namespace") | fallback("") }}/{{ ingress | dig("metadata", "name") | fallback("") }} ({{ len(allPaths) }} regex paths)
        {%- for _, rule := range rules %}
        {%- var http = rule | dig("http") %}
        {%- if http != nil %}
          {%- var paths = http | dig("paths") | fallback([]any{}) %}
          {%- for _, path := range paths %}
          {%- if path | dig("pathType") == "ImplementationSpecific" %}
      {{ rule | dig("host") | fallback("") }}{{ path | dig("path") | fallback("") }} {{ render "util-backend-name-ingress" -}}
          {%- end %}
          {%- end %}
        {%- end %}
        {%- end %}
      {%- end %}
      {%- end %}
      {%- end %}
