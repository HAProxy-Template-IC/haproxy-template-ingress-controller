# yaml-language-server: $schema=https://raw.githubusercontent.com/helm-unittest/helm-unittest/main/schema/helm-testsuite.json
suite: prometheus rule
templates:
  - prometheusrule.yaml
tests:
  - it: should not render when prometheusRule is disabled
    set:
      monitoring.prometheusRule.enabled: false
    asserts:
      - hasDocuments:
          count: 0

  - it: should render when prometheusRule is enabled
    set:
      monitoring.prometheusRule.enabled: true
    asserts:
      - hasDocuments:
          count: 1
      - isKind:
          of: PrometheusRule

  - it: should set correct apiVersion
    set:
      monitoring.prometheusRule.enabled: true
    asserts:
      - isAPIVersion:
          of: monitoring.coreos.com/v1

  - it: should include default reconciliation errors alert
    set:
      monitoring.prometheusRule.enabled: true
    asserts:
      - contains:
          path: spec.groups[0].rules
          content:
            alert: HAProxyControllerReconciliationErrors
            expr: rate(haptic_reconciliation_errors_total[5m]) > 0
            for: 5m
            labels:
              severity: warning
            annotations:
              summary: "HAProxy controller has reconciliation errors"
              description: "Controller {{ $labels.pod }} has {{ $value | humanize }} reconciliation errors/sec"

  - it: should include default deployment failures alert
    set:
      monitoring.prometheusRule.enabled: true
    asserts:
      - contains:
          path: spec.groups[0].rules
          content:
            alert: HAProxyControllerDeploymentFailures
            expr: rate(haptic_deployment_errors_total[5m]) > 0
            for: 2m
            labels:
              severity: critical
            annotations:
              summary: "HAProxy configuration deployment failures"
              description: "Controller {{ $labels.pod }} is failing to deploy configs to HAProxy"

  - it: should include default high queue depth alert
    set:
      monitoring.prometheusRule.enabled: true
    asserts:
      - contains:
          path: spec.groups[0].rules
          content:
            alert: HAProxyControllerHighQueueDepth
            expr: haptic_reconciliation_queue_size > 100
            for: 5m
            labels:
              severity: warning
            annotations:
              summary: "HAProxy controller reconciliation queue is backing up"
              description: "Queue depth is {{ $value }} items, indicating processing delays"

  - it: should include default no leader alert
    set:
      monitoring.prometheusRule.enabled: true
    asserts:
      - contains:
          path: spec.groups[0].rules
          content:
            alert: HAProxyControllerNoLeader
            expr: sum(haptic_leader_election_status) == 0
            for: 1m
            labels:
              severity: critical
            annotations:
              summary: "No HAProxy controller leader elected"
              description: "No controller instance holds the leader lock - deployments are stalled"

  - it: should disable reconciliation errors alert when configured
    set:
      monitoring.prometheusRule.enabled: true
      monitoring.prometheusRule.defaultRules.reconciliationErrors: false
    asserts:
      - notContains:
          path: spec.groups[0].rules
          content:
            alert: HAProxyControllerReconciliationErrors
          any: true

  - it: should disable deployment failures alert when configured
    set:
      monitoring.prometheusRule.enabled: true
      monitoring.prometheusRule.defaultRules.deploymentFailures: false
    asserts:
      - notContains:
          path: spec.groups[0].rules
          content:
            alert: HAProxyControllerDeploymentFailures
          any: true

  - it: should disable high queue depth alert when configured
    set:
      monitoring.prometheusRule.enabled: true
      monitoring.prometheusRule.defaultRules.highQueueDepth: false
    asserts:
      - notContains:
          path: spec.groups[0].rules
          content:
            alert: HAProxyControllerHighQueueDepth
          any: true

  - it: should disable leader election alert when configured
    set:
      monitoring.prometheusRule.enabled: true
      monitoring.prometheusRule.defaultRules.leaderElectionLost: false
    asserts:
      - notContains:
          path: spec.groups[0].rules
          content:
            alert: HAProxyControllerNoLeader
          any: true

  - it: should use custom rules when provided
    set:
      monitoring.prometheusRule.enabled: true
      monitoring.prometheusRule.rules:
        - alert: CustomAlert
          expr: custom_metric > 100
          for: 10m
          labels:
            severity: info
          annotations:
            summary: "Custom alert"
    asserts:
      - contains:
          path: spec.groups[0].rules
          content:
            alert: CustomAlert
            expr: custom_metric > 100
            for: 10m
            labels:
              severity: info
            annotations:
              summary: "Custom alert"

  - it: should not include default rules when custom rules provided
    set:
      monitoring.prometheusRule.enabled: true
      monitoring.prometheusRule.rules:
        - alert: CustomAlert
          expr: custom_metric > 100
    asserts:
      - notContains:
          path: spec.groups[0].rules
          content:
            alert: HAProxyControllerReconciliationErrors
          any: true

  - it: should include custom labels
    set:
      monitoring.prometheusRule.enabled: true
      monitoring.prometheusRule.labels:
        prometheus: kube-prometheus
    asserts:
      - equal:
          path: metadata.labels.prometheus
          value: kube-prometheus

  - it: should include common labels
    set:
      monitoring.prometheusRule.enabled: true
      commonLabels:
        environment: production
    asserts:
      - equal:
          path: metadata.labels.environment
          value: production

  - it: should include common annotations
    set:
      monitoring.prometheusRule.enabled: true
      commonAnnotations:
        team: platform
    asserts:
      - equal:
          path: metadata.annotations.team
          value: platform

  - it: should set group name
    set:
      monitoring.prometheusRule.enabled: true
    asserts:
      - equal:
          path: spec.groups[0].name
          value: haptic
