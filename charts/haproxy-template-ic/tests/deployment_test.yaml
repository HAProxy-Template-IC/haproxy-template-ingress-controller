# yaml-language-server: $schema=https://raw.githubusercontent.com/helm-unittest/helm-unittest/main/schema/helm-testsuite.json
suite: controller deployment
templates:
  - deployment.yaml
  - secret.yaml
tests:
  - it: should render deployment with correct kind
    template: deployment.yaml
    asserts:
      - isKind:
          of: Deployment

  - it: should use default replica count of 2
    template: deployment.yaml
    asserts:
      - equal:
          path: spec.replicas
          value: 2

  - it: should set replica count from values
    template: deployment.yaml
    set:
      replicaCount: 5
    asserts:
      - equal:
          path: spec.replicas
          value: 5

  - it: should not set replicas when autoscaling is enabled
    template: deployment.yaml
    set:
      autoscaling.enabled: true
    asserts:
      - notExists:
          path: spec.replicas

  - it: should set controller container name
    template: deployment.yaml
    asserts:
      - equal:
          path: spec.template.spec.containers[0].name
          value: controller

  - it: should set security context with readOnlyRootFilesystem
    template: deployment.yaml
    asserts:
      - equal:
          path: spec.template.spec.containers[0].securityContext.readOnlyRootFilesystem
          value: true

  - it: should set security context to run as non-root
    template: deployment.yaml
    asserts:
      - equal:
          path: spec.template.spec.containers[0].securityContext.runAsNonRoot
          value: true

  - it: should drop all capabilities
    template: deployment.yaml
    asserts:
      - contains:
          path: spec.template.spec.containers[0].securityContext.capabilities.drop
          content: ALL

  - it: should expose healthz port
    template: deployment.yaml
    asserts:
      - contains:
          path: spec.template.spec.containers[0].ports
          content:
            name: healthz
            containerPort: 8080
            protocol: TCP

  - it: should expose metrics port
    template: deployment.yaml
    asserts:
      - contains:
          path: spec.template.spec.containers[0].ports
          content:
            name: metrics
            containerPort: 9090
            protocol: TCP

  - it: should set resources when specified
    template: deployment.yaml
    set:
      resources:
        limits:
          cpu: 500m
          memory: 256Mi
        requests:
          cpu: 100m
          memory: 128Mi
    asserts:
      - equal:
          path: spec.template.spec.containers[0].resources.limits.cpu
          value: 500m
      - equal:
          path: spec.template.spec.containers[0].resources.limits.memory
          value: 256Mi

  - it: should mount tmp volume
    template: deployment.yaml
    asserts:
      - contains:
          path: spec.template.spec.containers[0].volumeMounts
          content:
            name: tmp
            mountPath: /tmp

  - it: should include tmp emptyDir volume
    template: deployment.yaml
    asserts:
      - contains:
          path: spec.template.spec.volumes
          content:
            name: tmp
            emptyDir: {}

  - it: should set priorityClassName when specified
    template: deployment.yaml
    set:
      priorityClassName: high-priority
    asserts:
      - equal:
          path: spec.template.spec.priorityClassName
          value: high-priority

  - it: should set nodeSelector when specified
    template: deployment.yaml
    set:
      nodeSelector:
        disktype: ssd
    asserts:
      - equal:
          path: spec.template.spec.nodeSelector.disktype
          value: ssd

  - it: should set tolerations when specified
    template: deployment.yaml
    set:
      tolerations:
        - key: node-role.kubernetes.io/master
          effect: NoSchedule
    asserts:
      - contains:
          path: spec.template.spec.tolerations
          content:
            key: node-role.kubernetes.io/master
            effect: NoSchedule

  - it: should expose webhook port when enabled
    template: deployment.yaml
    set:
      webhook.enabled: true
    asserts:
      - contains:
          path: spec.template.spec.containers[0].ports
          content:
            name: webhook
            containerPort: 9443
            protocol: TCP

  - it: should mount webhook certs when webhook enabled
    template: deployment.yaml
    set:
      webhook.enabled: true
    asserts:
      - contains:
          path: spec.template.spec.containers[0].volumeMounts
          content:
            name: webhook-certs
            mountPath: /etc/webhook/certs
            readOnly: true
