# HAProxyTech annotation library for HAProxy Template Ingress Controller
# Contains template snippets for haproxy.org/* annotations and corresponding validation tests
#
# IMPORTANT: This library provides INGRESS-ONLY annotation support.
# Gateway API resources (HTTPRoute, GRPCRoute) use filters instead of annotations.
# See charts/haproxy-template-ic/docs/libraries/gateway.md for Gateway API filter documentation.

watchedResources:
  secrets:
    apiVersion: v1
    resources: secrets
    indexBy: ["metadata.namespace", "metadata.name"]

templateSnippets:
  util-auth-userlist-name:
    template: |
      {#- Macro for generating userlist names from auth secret references -#}
      {% macro GetUserlistName(authSecret string, namespace string) string %}{%%
        if authSecret contains "/" {
          var parts = split(authSecret, "/")
          show "auth_" + parts[0] + "_" + parts[1]
        } else {
          show "auth_" + namespace + "_" + authSecret
        }
      %%}{% end %}

  # Utility snippet: HAProxyTech SSL Passthrough Cache
  # Provides cached analysis of Ingress resources with haproxy.org/ssl-passthrough annotation
  util-haproxytech-ssl-passthrough:
    template: |
      {#-
        HAProxyTech SSL Passthrough Analysis Cache

        Scans Ingress resources for haproxy.org/ssl-passthrough annotation and caches results.
        The analysis runs only ONCE per render, even when included from multiple locations.

        After including this snippet, the following variable is available:
          shared.haproxytech_sslPassthrough - map containing:
            .backends - list of SSL passthrough backend definitions
                        Each entry has: name, sni, namespace, ingress

        Usage:
          {{ render "util-haproxytech-ssl-passthrough" }}
          {%- for _, backend := range shared["haproxytech_sslPassthrough"].(map[string]any)["backends"].([]any) %}
            ... configure backend ...
          {%- end %}

        Note: Uses 'shared' namespace to cache data across template renders
        (haproxy.cfg, map files, etc.) within the same reconciliation.
      -#}
      {%- if !has_cached("haproxytech_sslPassthrough") %}
        {#- Initialize the cache structure -#}
        {%- shared["haproxytech_sslPassthrough"] = map[string]any{"backends": []any{}} %}
        {%- for _, ingress := range resources.ingresses.List() %}
          {%- var sslPassthrough = ingress | dig("metadata", "annotations", "haproxy.org/ssl-passthrough") | fallback("") %}
          {%- if sslPassthrough == "true" %}
            {%- var rules = ingress | dig("spec", "rules") | fallback([]any{}) %}
            {%- for _, rule := range rules %}
              {%- var host = rule | dig("host") %}
              {%- if host != nil %}
                {#- Deduplicate by hostname to prevent duplicate use_backend rules -#}
                {%- if first_seen("haproxytech_sslPassthrough_host", host) %}
                  {%- var ns = ingress | dig("metadata", "namespace") | fallback("") | tostring() %}
                  {%- var name = ingress | dig("metadata", "name") | fallback("") | tostring() %}
                  {%- var backendName = "ssl-passthrough-" + ns + "-" + name %}
                  {%- var backendInfo = map[string]any{
                    "name": backendName,
                    "sni": host,
                    "namespace": ns,
                    "ingress": name,
                  } %}
                  {%- shared["haproxytech_sslPassthrough"].(map[string]any)["backends"] = append(shared["haproxytech_sslPassthrough"].(map[string]any)["backends"].([]any), backendInfo) %}
                {%- end %}
              {%- end %}
            {%- end %}
          {%- end %}
        {%- end %}
        {%- set_cached("haproxytech_sslPassthrough", true) %}
      {%- end %}

  frontend-filters-400-haproxytech-ssl-redirect:

    template: |
      {#-
        HAProxy SSL Redirect (Ingress Only)
        Documentation: https://www.haproxy.com/documentation/kubernetes-ingress/community/configuration-reference/ingress/#ssl-redirect

        Annotations:
          - haproxy.org/ssl-redirect: "true" or "false" (optional, forces HTTPS redirect)
          - haproxy.org/ssl-redirect-code: HTTP status code for SSL redirect (optional, default: "302")
          - haproxy.org/ssl-redirect-port: Target HTTPS port (optional, default: "443")

        Format:
          ssl-redirect: "true" or "false"
          ssl-redirect-code: HTTP status code (e.g., "301", "302")
          ssl-redirect-port: Port number (e.g., "443", "8443")

        Generated HAProxy Config:
          http-request redirect scheme https code <code> if !{ ssl_fc } { var(txn.host) -m str <host1> } or { var(txn.host) -m str <host2> } ...

        Note: Redirect only applies to hosts defined in the ingress with this annotation
      -#}
      {%- for _, ingress := range resources.ingresses.List() %}
        {%- var ns = ingress | dig("metadata", "namespace") | fallback("") | tostring() %}
        {%- var name = ingress | dig("metadata", "name") | fallback("") | tostring() %}
        {%- var ingressKey = ns + "/" + name %}
        {%- if first_seen("haproxytech_sslRedirect", ingressKey) %}
          {%- var sslRedirect = ingress | dig("metadata", "annotations", "haproxy.org/ssl-redirect") | fallback("") %}
          {%- if sslRedirect == "true" %}
            {%- var sslRedirect_code = ingress | dig("metadata", "annotations", "haproxy.org/ssl-redirect-code") | fallback("302") %}
            {%- var sslRedirect_port = ingress | dig("metadata", "annotations", "haproxy.org/ssl-redirect-port") | fallback("443") %}
            {#- Extract all hosts from ingress rules -#}
            {%- var hosts = []any{} %}
            {%- var rules = ingress | dig("spec", "rules") | fallback([]any{}) %}
            {%- for _, rule := range rules %}
              {%- var host = rule | dig("host") %}
              {%- if host != nil %}
                {%- hosts = append(hosts, host) %}
              {%- end %}
            {%- end %}
            {#- Generate host-scoped redirect rule -#}
            {%- if len(hosts) > 0 %}
      # haproxytech/frontend-filters-haproxytech-ssl-redirect (for {{ ingressKey }})
      http-request redirect scheme https code {{ sslRedirect_code }} if !{ ssl_fc } {% for i, host := range hosts %}{ var(txn.host) -m str {{ host }} }{% if i < len(hosts) - 1 %} or {% end %}{% end %}
            {%- end %}
          {%- end %}
        {%- end %}
      {%- end -%}
  frontend-filters-450-haproxytech-redirects:

    template: |
      {#-
        HAProxy Request Redirect (Ingress Only)
        Documentation: https://www.haproxy.com/documentation/kubernetes-ingress/community/configuration-reference/ingress/#request-redirect

        Annotations:
          - haproxy.org/request-redirect: Target host/URL for redirect (required to enable redirect)
          - haproxy.org/request-redirect-code: HTTP status code for redirect (optional, default: "302")

        Format:
          request-redirect: "example.com", "example.com:8888", "https://example.com", "http://example.com"
          request-redirect-code: HTTP status code (e.g., "301", "302", "303", "307", "308")

        Generated HAProxy Config:
          http-request redirect location <url> code <code> if { var(txn.host) -m str <host1> } or { var(txn.host) -m str <host2> } ...

        Note:
          - Redirect only applies to hosts defined in the ingress with this annotation
          - Protocol prefix in redirect URL sets SSL flag
      -#}
      {%- for _, ingress := range resources.ingresses.List() %}
        {%- var ns = ingress | dig("metadata", "namespace") | fallback("") | tostring() %}
        {%- var name = ingress | dig("metadata", "name") | fallback("") | tostring() %}
        {%- var ingressKey = ns + "/" + name %}
        {%- if first_seen("haproxytech_redirects", ingressKey) %}
          {%- var redirectTarget = ingress | dig("metadata", "annotations", "haproxy.org/request-redirect") | fallback("") %}
          {%- if redirectTarget != "" %}
            {%- var redirectCode = ingress | dig("metadata", "annotations", "haproxy.org/request-redirect-code") | fallback("302") %}
            {%- var validCodes = []string{"301", "302", "303", "307", "308"} %}
            {%- var codeValid = false %}
            {%- for _, valid := range validCodes %}
              {%- if tostring(redirectCode) == valid %}
                {%- codeValid = true %}
              {%- end %}
            {%- end %}
            {%- if !codeValid %}
              {{- fail("Invalid value '" + tostring(redirectCode) + "' for annotation 'haproxy.org/request-redirect-code' on Ingress '" + ingressKey + "'. Valid values: 301, 302, 303, 307, 308") -}}
            {%- end %}
            {#- Extract all hosts from ingress rules -#}
            {%- var hosts = []any{} %}
            {%- var rules = ingress | dig("spec", "rules") | fallback([]any{}) %}
            {%- for _, rule := range rules %}
              {%- var host = rule | dig("host") %}
              {%- if host != nil %}
                {%- hosts = append(hosts, host) %}
              {%- end %}
            {%- end %}
            {#- Generate host-scoped redirect rule -#}
            {%- if len(hosts) > 0 %}
      # haproxytech/frontend-filters-haproxytech-redirects (for {{ ingressKey }})
      http-request redirect location {{ redirectTarget }} code {{ redirectCode }} if {% for i, host := range hosts %}{ var(txn.host) -m str {{ host }} }{% if i < len(hosts) - 1 %} or {% end %}{% end %}
            {%- end %}
          {%- end %}
        {%- end %}
      {%- end -%}
  frontend-filters-300-haproxytech-cors:
    template: |
      {#-
        HAProxy CORS Configuration (Ingress Only)
        Documentation: https://www.haproxy.com/documentation/kubernetes-ingress/community/configuration-reference/ingress/#cors-enable

        Annotations:
          - haproxy.org/cors-enable: "true" or "false" (required for CORS)
          - haproxy.org/cors-allow-origin: Allowed origins - "*", exact URL, or regex (optional, default: "*")
          - haproxy.org/cors-allow-methods: Allowed HTTP methods comma-separated (optional, default: "GET, POST")
          - haproxy.org/cors-allow-headers: Allowed request headers comma-separated (optional)
          - haproxy.org/cors-allow-credentials: "true" or "false" (optional, default: "false")
          - haproxy.org/cors-max-age: Preflight cache duration, seconds (optional, default: 0)

        Generated HAProxy Config:
          http-request capture req.hdr(Origin) len 128 if { var(txn.host) -m str <host> }
          http-response set-header Access-Control-Allow-Origin "..." if { var(txn.host) -m str <host> }
          http-response set-header Access-Control-Allow-Methods "..." if { var(txn.host) -m str <host> }
          http-response set-header Access-Control-Allow-Headers "..." if { var(txn.host) -m str <host> }
          http-response set-header Access-Control-Allow-Credentials "true" if { var(txn.host) -m str <host> }
          http-response set-header Access-Control-Max-Age "..." if { var(txn.host) -m str <host> }

        Note: When cors-allow-credentials is true, cors-allow-origin cannot be "*"
        Note: CORS headers are scoped to hosts defined in the ingress to prevent cross-ingress leakage
      -#}
      {%- for _, ingress := range resources.ingresses.List() %}
        {%- var ns = ingress | dig("metadata", "namespace") | fallback("") | tostring() %}
        {%- var name = ingress | dig("metadata", "name") | fallback("") | tostring() %}
        {%- var ingressKey = ns + "/" + name %}
        {%- if first_seen("haproxytech_cors", ingressKey) %}
          {%- var corsEnable = ingress | dig("metadata", "annotations", "haproxy.org/cors-enable") | fallback("") %}
          {%- if corsEnable == "true" %}
            {%- var corsOrigin = ingress | dig("metadata", "annotations", "haproxy.org/cors-allow-origin") | fallback("*") %}
            {%- var corsMethods = ingress | dig("metadata", "annotations", "haproxy.org/cors-allow-methods") | fallback("GET, POST") %}
            {%- var corsHeaders = ingress | dig("metadata", "annotations", "haproxy.org/cors-allow-headers") | fallback("") %}
            {%- var corsCredentials = ingress | dig("metadata", "annotations", "haproxy.org/cors-allow-credentials") | fallback("false") %}
            {%- var corsMaxAge = ingress | dig("metadata", "annotations", "haproxy.org/cors-max-age") | fallback("0") %}
            {%- if corsCredentials == "true" && corsOrigin == "*" %}
              {{- fail("CORS configuration error on Ingress '" + ingressKey + "': cors-allow-credentials cannot be 'true' when cors-allow-origin is '*'. Specify an explicit origin.") -}}
            {%- end %}
            {#- Extract all hosts from ingress rules -#}
            {%- var hosts = []any{} %}
            {%- var rules = ingress | dig("spec", "rules") | fallback([]any{}) %}
            {%- for _, rule := range rules %}
              {%- var host = rule | dig("host") %}
              {%- if host != nil %}
                {%- hosts = append(hosts, host) %}
              {%- end %}
            {%- end %}
            {%- if len(hosts) > 0 %}
      # haproxytech/frontend-filters-haproxytech-cors (for {{ ingressKey }})
      http-request capture req.hdr(Origin) len 128 if {% for i, host := range hosts %}{ var(txn.host) -m str {{ host }} }{% if i < len(hosts) - 1 %} or {% end %}{% end %}

      http-response set-header Access-Control-Allow-Origin "{{ corsOrigin }}" if {% for i, host := range hosts %}{ var(txn.host) -m str {{ host }} }{% if i < len(hosts) - 1 %} or {% end %}{% end %}

      http-response set-header Access-Control-Allow-Methods "{{ corsMethods }}" if {% for i, host := range hosts %}{ var(txn.host) -m str {{ host }} }{% if i < len(hosts) - 1 %} or {% end %}{% end %}

              {% if corsHeaders != "" -%}
      http-response set-header Access-Control-Allow-Headers "{{ corsHeaders }}" if {% for i, host := range hosts %}{ var(txn.host) -m str {{ host }} }{% if i < len(hosts) - 1 %} or {% end %}{% end %}

              {% end -%}
              {% if corsCredentials == "true" -%}
      http-response set-header Access-Control-Allow-Credentials "true" if {% for i, host := range hosts %}{ var(txn.host) -m str {{ host }} }{% if i < len(hosts) - 1 %} or {% end %}{% end %}

              {% end -%}
              {% if corsMaxAge != "0" -%}
      http-response set-header Access-Control-Max-Age "{{ corsMaxAge }}" if {% for i, host := range hosts %}{ var(txn.host) -m str {{ host }} }{% if i < len(hosts) - 1 %} or {% end %}{% end %}

              {% end -%}
            {%- end %}
          {%- end %}
        {%- end %}
      {%- end -%}
  frontend-filters-200-haproxytech-access-control:
    template: |
      {#-
        HAProxy Access Control - IP Allowlist/Denylist (Ingress Only)
        Documentation: https://www.haproxy.com/documentation/kubernetes-ingress/community/configuration-reference/ingress/#allowlist

        Annotations:
          - haproxy.org/allowlist: Comma-separated list of IPs/CIDRs allowed (optional)
          - haproxy.org/denylist: Comma-separated list of IPs/CIDRs denied (optional)

        Format:
          Values: "192.168.1.0/24, 10.0.0.1, 172.16.0.0/16"

        Generated HAProxy Config:
          acl allowlist_<sanitized> src <ip/cidr>
          http-request deny if { var(txn.host) -m str <host> } !allowlist_<sanitized>

          acl denylist_<sanitized> src <ip/cidr>
          http-request deny if { var(txn.host) -m str <host> } denylist_<sanitized>

        Note: Both allowlist and denylist can be used together. Deny rules only apply to hosts defined in the ingress with this annotation.
      -#}
      {%- for _, ingress := range resources.ingresses.List() %}
        {%- var ns = ingress | dig("metadata", "namespace") | fallback("") | tostring() %}
        {%- var name = ingress | dig("metadata", "name") | fallback("") | tostring() %}
        {%- var ingressKey = ns + "/" + name %}
        {%- if first_seen("haproxytech_access_control", ingressKey) %}
          {%- var allowlist = ingress | dig("metadata", "annotations", "haproxy.org/allowlist") | fallback("") %}
          {%- var denylist = ingress | dig("metadata", "annotations", "haproxy.org/denylist") | fallback("") %}
          {#- Extract all hosts from ingress rules -#}
          {%- var hosts = []any{} %}
          {%- var rules = ingress | dig("spec", "rules") | fallback([]any{}) %}
          {%- for _, rule := range rules %}
            {%- var host = rule | dig("host") %}
            {%- if host != nil %}
              {%- hosts = append(hosts, host) %}
            {%- end %}
          {%- end %}
          {%- if allowlist != "" && len(hosts) > 0 %}
      # haproxytech/frontend-filters-haproxytech-access-control (allowlist for {{ ingressKey }})
            {%- var aclName = "haproxytech_allowlist_" + ns + "_" + name %}
      acl {{ aclName }} src{% for _, ip := range split(tostring(allowlist), ",") %}{% var ipTrimmed = trimSpace(ip) %}{% if ipTrimmed != "" %} {{ ipTrimmed }}{% end %}{% end %}
      http-request deny if {% for i, host := range hosts %}{ var(txn.host) -m str {{ host }} }{% if i < len(hosts) - 1 %} or {% end %}{% end %} !{{ aclName }}
          {%- end %}
          {%- if denylist != "" && len(hosts) > 0 %}
      # haproxytech/frontend-filters-haproxytech-access-control (denylist for {{ ingressKey }})
            {%- var aclName = "haproxytech_denylist_" + ns + "_" + name %}
      acl {{ aclName }} src{% for _, ip := range split(tostring(denylist), ",") %}{% var ipTrimmed = trimSpace(ip) %}{% if ipTrimmed != "" %} {{ ipTrimmed }}{% end %}{% end %}
      http-request deny if {% for i, host := range hosts %}{ var(txn.host) -m str {{ host }} }{% if i < len(hosts) - 1 %} or {% end %}{% end %} {{ aclName }}
          {%- end %}
        {%- end %}
      {%- end -%}
  frontend-filters-500-haproxytech-logging:
    template: |
      {#-
        HAProxy Request Capture & Source IP Detection (Ingress Only)
        Documentation: https://www.haproxy.com/documentation/kubernetes-ingress/community/configuration-reference/ingress/#request-capture

        Annotations:
          - haproxy.org/src-ip-header: Extract true client IP from header (optional, e.g., "CF-Connecting-IP")
          - haproxy.org/request-capture: Multiline list of HAProxy sample expressions to capture (optional)
          - haproxy.org/request-capture-len: Maximum length for captured data (optional, default: 128)

        Format:
          request-capture: One expression per line (e.g., "hdr(User-Agent)", "cookie(session)")
          request-capture-len: Integer (e.g., "256")

        Generated HAProxy Config:
          http-request set-src hdr(<header-name>) if { var(txn.host) -m str <host> }
          capture request header <expression> len <length>

        Note: src-ip-header useful when behind proxies/CDNs
        Note: src-ip-header is scoped to hosts defined in the ingress to prevent affecting ACLs for other ingresses
      -#}
      {%- for _, ingress := range resources.ingresses.List() %}
        {%- var ns = ingress | dig("metadata", "namespace") | fallback("") | tostring() %}
        {%- var name = ingress | dig("metadata", "name") | fallback("") | tostring() %}
        {%- var ingressKey = ns + "/" + name %}
        {%- if first_seen("haproxytech_logging", ingressKey) %}
          {%- var srcIpHeader = ingress | dig("metadata", "annotations", "haproxy.org/src-ip-header") | fallback("") %}
          {%- var requestCapture = ingress | dig("metadata", "annotations", "haproxy.org/request-capture") | fallback("") %}
          {%- var captureLen = ingress | dig("metadata", "annotations", "haproxy.org/request-capture-len") | fallback("128") %}
          {%- if srcIpHeader != "" %}
            {#- Extract all hosts from ingress rules -#}
            {%- var hosts = []any{} %}
            {%- var rules = ingress | dig("spec", "rules") | fallback([]any{}) %}
            {%- for _, rule := range rules %}
              {%- var host = rule | dig("host") %}
              {%- if host != nil %}
                {%- hosts = append(hosts, host) %}
              {%- end %}
            {%- end %}
            {%- if len(hosts) > 0 %}
      # haproxytech/frontend-filters-haproxytech-logging (src-ip-header for {{ ingressKey }})
      http-request set-src hdr({{ srcIpHeader }}) if {% for i, host := range hosts %}{ var(txn.host) -m str {{ host }} }{% if i < len(hosts) - 1 %} or {% end %}{% end %}
            {%- end %}
          {%- end %}
          {%- if requestCapture != "" %}
      # haproxytech/frontend-filters-haproxytech-logging (request-capture for {{ ingressKey }})
            {%- for _, line := range split(tostring(requestCapture), "\n") %}
              {%- var lineTrimmed = trimSpace(line) %}
              {%- if lineTrimmed != "" %}
      capture request header {{ lineTrimmed }} len {{ captureLen }}
              {%- end %}
            {%- end %}
          {%- end %}
        {%- end %}
      {%- end -%}
  frontend-filters-100-haproxytech-basic-headers:
    template: |
      {#-
        HAProxy Basic Header Manipulation (Ingress Only)
        Documentation: https://www.haproxy.com/documentation/kubernetes-ingress/community/configuration-reference/ingress/#forwarded-for

        Annotations:
          - haproxy.org/forwarded-for: "true" or "false" (optional, default: true)
          - haproxy.org/set-host: "<hostname>" (optional, set Host header after backend selection)

        Generated HAProxy Config:
          option forwardfor (if forwarded-for enabled)
          http-request set-header Host "<hostname>" (if set-host specified)

        Note: forwarded-for adds X-Forwarded-For header with client IP
        Note: set-host modifies Host header after backend selection
      -#}
      {#- Check if any ingress has forwarded-for enabled (frontend-level directive, output once) -#}
      {%- var forwardforEnabled = false %}
      {%- for _, ingress := range resources.ingresses.List() %}
        {%- var ns = ingress | dig("metadata", "namespace") | fallback("") | tostring() %}
        {%- var name = ingress | dig("metadata", "name") | fallback("") | tostring() %}
        {%- var ingressKey = ns + "/" + name %}
        {%- if first_seen("haproxytech_basic_headers", ingressKey) %}
          {%- var forwardedFor = ingress | dig("metadata", "annotations", "haproxy.org/forwarded-for") | fallback("") | tostring() %}
          {%- if forwardedFor != "" %}
            {%- if forwardedFor != "true" && forwardedFor != "false" %}
              {{- fail("Invalid value '" + forwardedFor + "' for annotation 'haproxy.org/forwarded-for' on Ingress '" + ingressKey + "'. Valid values: 'true', 'false'") -}}
            {%- end %}
            {%- if forwardedFor == "true" %}
              {%- forwardforEnabled = true %}
            {%- end %}
          {%- end %}
        {%- end %}
      {%- end %}
      {%- if forwardforEnabled %}
      # haproxytech/frontend-filters-haproxytech-basic-headers (forwarded-for)
      option forwardfor
      {%- end -%}
  frontend-filters-150-haproxytech-timeouts:
    template: |
      {#-
        HAProxy Frontend Timeout Configuration (Ingress Only)
        Documentation: https://www.haproxy.com/documentation/kubernetes-ingress/community/configuration-reference/ingress/#timeout-check

        Annotations:
          - haproxy.org/timeout-client: "<duration>" (optional, default: HAProxy global/frontend default)
          - haproxy.org/timeout-http-request: "<duration>" (optional, default: HAProxy global/frontend default)
          - haproxy.org/timeout-http-keep-alive: "<duration>" (optional, default: HAProxy global/frontend default)

        Duration Format:
          HAProxy duration format: integer with optional unit suffix
          - Units: us (microseconds), ms (milliseconds), s (seconds), m (minutes), h (hours), d (days)
          - Examples: "5s", "100ms", "1m", "2h", "30s"
          - Default unit if none specified: milliseconds

        Generated HAProxy Config:
          timeout client <duration>
          timeout http-request <duration>
          timeout http-keep-alive <duration>

        Note: These timeouts MUST be in frontend context per HAProxy specification
        Note: Backend timeouts (server, connect, queue, tunnel, check) are in backend-directives-haproxytech-timeouts
      -#}
      {%- for _, ingress := range resources.ingresses.List() %}
        {%- var ns = ingress | dig("metadata", "namespace") | fallback("") | tostring() %}
        {%- var name = ingress | dig("metadata", "name") | fallback("") | tostring() %}
        {%- var ingressKey = ns + "/" + name %}
        {%- if first_seen("haproxytech_timeouts", ingressKey) %}
          {%- var timeoutClient = ingress | dig("metadata", "annotations", "haproxy.org/timeout-client") | fallback("") %}
          {%- var timeoutHttpRequest = ingress | dig("metadata", "annotations", "haproxy.org/timeout-http-request") | fallback("") %}
          {%- var timeoutHttpKeepAlive = ingress | dig("metadata", "annotations", "haproxy.org/timeout-http-keep-alive") | fallback("") %}
          {%- if timeoutClient != "" %}
      # haproxytech/frontend-filters-haproxytech-timeouts
      timeout client {{ timeoutClient }}
          {% end %}
          {%- if timeoutHttpRequest != "" %}
      timeout http-request {{ timeoutHttpRequest }}
          {% end %}
          {%- if timeoutHttpKeepAlive != "" %}
      timeout http-keep-alive {{ timeoutHttpKeepAlive }}
          {% end %}
        {%- end %}
      {%- end -%}
  global-top-500-haproxytech-ingress-auth:
    template: |
      {#-
        HAProxy Basic Authentication Support (Ingress Only)
        Documentation: https://www.haproxy.com/documentation/kubernetes-ingress/community/configuration-reference/ingress/#auth-secret

        Annotations:
          - haproxy.org/auth-type: "basic-auth" (required)
          - haproxy.org/auth-secret: "<secret-name>" or "<namespace>/<secret-name>" (required)
          - haproxy.org/auth-realm: "<realm>" (optional, default: "RestrictedArea")

        Secret Format:
          The auth-secret must be an Opaque secret where:
            - Key: username (e.g., "admin")
            - Value: base64-encoded password hash (e.g., base64("$apr1$..."))

          IMPORTANT: The value contains ONLY the password hash, NOT "username:hash" (htpasswd format).

          Example Secret:
            apiVersion: v1
            kind: Secret
            metadata:
              name: my-auth
              namespace: default
            type: Opaque
            data:
              admin: JDJ5JDA1JG1OMVdWazVRbmJnNFF3ZEFkWGJmei44YjNjZUg2UTVLT1ZDS3hSMklrTkFmSmdMaTVwSUtX  # base64($2y$05$...) bcrypt hash

          Generate Password Hash:
            # Create bcrypt hash and encode to base64 (HAProxy 3.2+ supports bcrypt, not MD5 apr1)
            htpasswd -nbB admin mypassword | cut -d: -f2 | base64 -w0

        Generated HAProxy Config:
          userlist auth_<namespace>_<secret-name>
            user <username> password <hash>

          Cross-namespace secrets use format: auth_<secret-namespace>_<secret-name>

        Deduplication:
          Multiple ingresses referencing the same secret share one userlist.
      -#}
      {%- for _, ingress := range resources.ingresses.List() %}
        {%- var ingressNs = ingress | dig("metadata", "namespace") | fallback("") | tostring() %}
        {%- var ingressName = ingress | dig("metadata", "name") | fallback("") | tostring() %}
        {%- var authType = ingress | dig("metadata", "annotations", "haproxy.org/auth-type") | fallback("") | tostring() %}
        {%- if authType != "" && authType != "basic-auth" %}
          {{- fail("Invalid value '" + authType + "' for annotation 'haproxy.org/auth-type' on Ingress '" + ingressNs + "/" + ingressName + "'. Valid values: 'basic-auth'") -}}
        {%- end %}
        {%- if authType == "basic-auth" %}
          {%- var authSecret = ingress | dig("metadata", "annotations", "haproxy.org/auth-secret") | fallback("") | tostring() %}
          {%- if authSecret != "" %}
            {#- Generate userlist name based on secret reference -#}
            {%- var userlistName = "" %}
            {%- var secretNamespace = "" %}
            {%- var secretName = "" %}
            {%- if strings_contains(authSecret, "/") %}
              {%- var parts = split(authSecret, "/") %}
              {%- secretNamespace = parts[0] %}
              {%- secretName = parts[1] %}
              {%- userlistName = "auth_" + secretNamespace + "_" + secretName %}
            {%- else %}
              {%- secretNamespace = ingressNs %}
              {%- secretName = authSecret %}
              {%- userlistName = "auth_" + ingressNs + "_" + authSecret %}
            {%- end %}

            {#- Only process each userlist once -#}
            {%- if first_seen("haproxytech_userlist", userlistName) %}
              {#- Fetch secret from store -#}
              {%- var secret = resources.secrets.GetSingle(secretNamespace, secretName) %}
              {%- if secret != nil %}
      # haproxytech/global-top-haproxytech-ingress-auth
      userlist {{ userlistName }}
                {% var secretData = secret | dig("data") | fallback(map[string]any{}) -%}
                {%- for username, hash := range secretData %}
        user {{ username }} password {{ hash | b64decode() }}
                {% end -%}
              {%- else %}
                {{- fail("Secret '" + secretNamespace + "/" + secretName + "' referenced by annotation 'haproxy.org/auth-secret' does not exist. Please create the secret or update the annotation.") -}}
              {%- end %}
            {%- end %}
          {%- end %}
        {%- end %}
      {%- end -%}

  backend-directives-150-haproxytech-load-balance:
    template: |
      {#-
        HAProxy Load Balancing Algorithm (Ingress Only)

        Documentation: https://www.haproxy.com/documentation/kubernetes-ingress/community/configuration-reference/ingress/#load-balance

        Annotations:
          - haproxy.org/load-balance: "<algorithm>" (optional, default: roundrobin)

        Valid Algorithms:
          - roundrobin: Each server is used in turns
          - leastconn: Server with lowest number of connections receives traffic
          - source: Source IP hash determines server
          - uri: URI hash determines server
          - hdr: HTTP header hash determines server
          - random: Random server selection
          - rdp-cookie: RDP cookie-based persistence

        Generated HAProxy Config:
          balance <algorithm>

        Note: This snippet requires 'ingress' variable in context (only set by Ingress backend generation)
      -#}
      {%- if ingress != nil %}
      {%- var loadBalance = ingress | dig("metadata", "annotations", "haproxy.org/load-balance") | fallback("") | tostring() %}
      {%- if loadBalance != "" %}
        {%- var validAlgorithms = []string{"roundrobin", "leastconn", "source", "uri", "hdr", "random", "rdp-cookie"} %}
        {%- var isValid = false %}
        {%- for _, alg := range validAlgorithms %}
          {%- if loadBalance == alg %}
            {%- isValid = true %}
          {%- end %}
        {%- end %}
        {%- if !isValid %}
          {%- var ingressNs = ingress | dig("metadata", "namespace") | fallback("") | tostring() %}
          {%- var ingressName = ingress | dig("metadata", "name") | fallback("") | tostring() %}
          {{- fail("Invalid value '" + loadBalance + "' for annotation 'haproxy.org/load-balance' on Ingress '" + ingressNs + "/" + ingressName + "'. Valid values: " + (validAlgorithms | join(", "))) -}}
        {%- end %}
      # haproxytech/backend-directives-haproxytech-load-balance
      balance {{ loadBalance }}
      {%- end %}
      {%- end -%}

  backend-directives-250-haproxytech-rate-limiting:
    template: |
      {#-
        HAProxy Rate Limiting (Ingress Only)

        Documentation: https://www.haproxy.com/documentation/kubernetes-ingress/community/configuration-reference/ingress/#rate-limit-requests

        Annotations:
          - haproxy.org/rate-limit-requests: Maximum requests in period, per source IP (required to enable rate limiting)
          - haproxy.org/rate-limit-period: Time window for rate limiting, duration format (optional, default: "1s")
          - haproxy.org/rate-limit-size: Stick-table size for tracking IPs (optional, default: "100k")
          - haproxy.org/rate-limit-status-code: HTTP status code when rate limit exceeded (optional, default: "403")

        Format:
          rate-limit-requests: Integer (e.g., "100")
          rate-limit-period: Duration (e.g., "1m", "10s")
          rate-limit-size: Integer with optional k/M suffix (e.g., "100k", "1000000")
          rate-limit-status-code: HTTP status code (e.g., "429", "503")

        Generated HAProxy Config:
          stick-table type ip size <size> expire <period> store http_req_rate(<period>)
          http-request track-sc0 src
          http-request deny deny_status <code> if { sc_http_req_rate(0) gt <requests> }

        Note: This snippet requires 'ingress' variable in context (only set by Ingress backend generation)
        Note: Creates per-backend stick-table for rate limiting
      -#}
      {%- if ingress != nil %}
      {%- var rateRequests = ingress | dig("metadata", "annotations", "haproxy.org/rate-limit-requests") | fallback("") | tostring() %}
      {%- if rateRequests != "" %}
        {%- var ratePeriod = ingress | dig("metadata", "annotations", "haproxy.org/rate-limit-period") | fallback("1s") %}
        {%- var rateSize = ingress | dig("metadata", "annotations", "haproxy.org/rate-limit-size") | fallback("100k") %}
        {%- var rateStatus = ingress | dig("metadata", "annotations", "haproxy.org/rate-limit-status-code") | fallback("403") %}
      # haproxytech/backend-directives-haproxytech-rate-limiting
      stick-table type ip size {{ rateSize }} expire {{ ratePeriod }} store http_req_rate({{ ratePeriod }})
      http-request track-sc0 src
      http-request deny deny_status {{ rateStatus }} if { sc_http_req_rate(0) gt {{ rateRequests }} }
      {%- end %}
      {%- end -%}

  backend-directives-400-haproxytech-session-persistence:

    template: |
      {#-
        HAProxy Session Persistence - Sticky Sessions (Ingress Only)

        Documentation: https://www.haproxy.com/documentation/kubernetes-ingress/community/configuration-reference/ingress/#cookie-persistence

        Annotations:
          - haproxy.org/cookie-persistence: Cookie name for dynamic sticky sessions (optional)

        Format:
          cookie-persistence: Cookie name (e.g., "SERVERID", "JSESSIONID")

        Generated HAProxy Config:
          cookie <name> insert indirect nocache dynamic
          dynamic-cookie-key <generated-key>

        Note: This snippet requires 'ingress' variable in context (only set by Ingress backend generation)
        Note: Uses dynamic cookies for multi-instance controller deployments
        Note: Mutually exclusive with cookie-persistence-no-dynamic
      -#}
      {%- if ingress != nil %}
      {%- var cookieName = ingress | dig("metadata", "annotations", "haproxy.org/cookie-persistence") | fallback("") | tostring() %}
      {%- if cookieName != "" %}
      # haproxytech/backend-directives-haproxytech-session-persistence
      cookie {{ cookieName }} insert indirect nocache dynamic
      # Note: dynamic-cookie-key would be set by base template for multi-instance support
      {%- end %}
      {%- end -%}

  backend-directives-401-haproxytech-session-persistence-no-dynamic:
    template: |
      {#-
        HAProxy Session Persistence - Static Cookies (Ingress Only)

        Documentation: https://www.haproxy.com/documentation/kubernetes-ingress/community/configuration-reference/ingress/#cookie-persistence

        Annotations:
          - haproxy.org/cookie-persistence-no-dynamic: Cookie name for static sticky sessions (optional)

        Format:
          cookie-persistence-no-dynamic: Cookie name (e.g., "SERVERID", "JSESSIONID")

        Generated HAProxy Config:
          cookie <name> insert indirect nocache

        Note: This snippet requires 'ingress' variable in context (only set by Ingress backend generation)
        Note: Use only in single-instance controller deployments
        Note: Mutually exclusive with cookie-persistence
        Note: Static cookies will differ across controller instances, breaking session affinity in multi-instance deployments
      -#}
      {%- if ingress != nil %}
      {%- var cookieDynamic = ingress | dig("metadata", "annotations", "haproxy.org/cookie-persistence") | fallback("") | tostring() %}
      {%- var cookieStatic = ingress | dig("metadata", "annotations", "haproxy.org/cookie-persistence-no-dynamic") | fallback("") | tostring() %}
      {%- if cookieDynamic != "" && cookieStatic != "" %}
        {%- var ingressNs = ingress | dig("metadata", "namespace") | fallback("") | tostring() %}
        {%- var ingressName = ingress | dig("metadata", "name") | fallback("") | tostring() %}
        {{- fail("Cannot use both 'haproxy.org/cookie-persistence' and 'haproxy.org/cookie-persistence-no-dynamic' on Ingress '" + ingressNs + "/" + ingressName + "'. Use only one cookie persistence method.") -}}
      {%- end %}
      {%- if cookieStatic != "" %}
      # haproxytech/backend-directives-haproxytech-session-persistence-no-dynamic
      cookie {{ cookieStatic }} insert indirect nocache
      {%- end %}
      {%- end -%}

  backend-directives-900-haproxytech-advanced:
    template: |
      {#-
        HAProxy Advanced Backend Configuration (Ingress Only)

        Documentation: https://www.haproxy.com/documentation/kubernetes-ingress/community/configuration-reference/ingress/#backend-config-snippet

        ## Server Protocol and Security
        Annotations:
          - haproxy.org/send-proxy-protocol: PROXY protocol for backends (optional)
          - haproxy.org/server-ssl: Enable SSL/TLS to backend servers (optional)
          - haproxy.org/server-proto: Backend protocol, e.g., "h2" for HTTP/2 (optional)
          - haproxy.org/server-crt: Client cert for mTLS to backend (optional, requires secrets watching)
          - haproxy.org/server-ca: CA cert for backend verification (optional, requires secrets watching)

        ## Scaling Configuration
        Annotations:
          - haproxy.org/scale-server-slots: Pre-allocate server slots for scaling (optional, default: 10 from base library)

        ## Raw Configuration Injection
        Annotations:
          - haproxy.org/backend-config-snippet: Raw HAProxy backend directives (optional)

        Format:
          send-proxy-protocol: "proxy", "proxy-v1", "proxy-v2", "proxy-v2-ssl", "proxy-v2-ssl-cn"
          server-ssl: "true" or "false"
          server-proto: Protocol string (e.g., "h2", "h2c")
          server-crt: Secret name with client cert (e.g., "namespace/secret-name" or "secret-name")
          server-ca: Secret name with CA cert (e.g., "namespace/secret-name" or "secret-name")
          scale-server-slots: Integer (e.g., "100")
          backend-config-snippet: Multiline YAML string with raw HAProxy config

        Generated HAProxy Config:
          (server directives with SSL, proto, and send-proxy flags)
          (pre-allocated server slots for scaling)
          <raw config from backend-config-snippet>

        WARNING: backend-config-snippet bypasses validation - user is responsible for correct syntax

        Note: This snippet requires 'ingress' variable in context (only set by Ingress backend generation)
      -#}
      {%- if ingress != nil %}
      {#- Append to server option flags (serverOpts passed via inherit_context) -#}
      {#- This variable is only initialized for Ingress backends (ingress.yaml), not Gateway API -#}
      {%- var ingressNs = ingress | dig("metadata", "namespace") | fallback("") | tostring() %}

      {#- send-proxy-protocol -#}
      {%- var sendProxy = ingress | dig("metadata", "annotations", "haproxy.org/send-proxy-protocol") | fallback("") | tostring() %}
      {%- if sendProxy != "" %}
        {%- if sendProxy == "proxy" || sendProxy == "proxy-v1" %}
          {%- serverOpts["flags"] = append(serverOpts["flags"].([]any), "send-proxy") %}
        {%- else if sendProxy == "proxy-v2" %}
          {%- serverOpts["flags"] = append(serverOpts["flags"].([]any), "send-proxy-v2") %}
        {%- else if sendProxy == "proxy-v2-ssl" %}
          {%- serverOpts["flags"] = append(serverOpts["flags"].([]any), "send-proxy-v2-ssl") %}
        {%- else if sendProxy == "proxy-v2-ssl-cn" %}
          {%- serverOpts["flags"] = append(serverOpts["flags"].([]any), "send-proxy-v2-ssl-cn") %}
        {%- end %}
      {%- end %}

      {#- server-ssl -#}
      {%- var serverSsl = ingress | dig("metadata", "annotations", "haproxy.org/server-ssl") | fallback("") | tostring() %}
      {%- if serverSsl == "true" %}
        {%- serverOpts["flags"] = append(serverOpts["flags"].([]any), "ssl verify none") %}
      {%- end %}

      {#- server-proto -#}
      {%- var serverProto = ingress | dig("metadata", "annotations", "haproxy.org/server-proto") | fallback("") | tostring() %}
      {%- if serverProto != "" %}
        {%- serverOpts["flags"] = append(serverOpts["flags"].([]any), "proto " + serverProto) %}
      {%- end %}

      {#- server-ca: CA certificate for backend verification -#}
      {%- var serverCa = ingress | dig("metadata", "annotations", "haproxy.org/server-ca") | fallback("") | tostring() %}
      {%- if serverCa != "" %}
        {#- Parse secret namespace/name (format: "namespace/secret-name") -#}
        {%- var caNamespace = "" %}
        {%- var caName = "" %}
        {%- if strings_contains(serverCa, "/") %}
          {%- var caParts = split(serverCa, "/") %}
          {%- caNamespace = caParts[0] %}
          {%- caName = caParts[1] %}
        {%- else %}
          {#- Same namespace as ingress if not specified -#}
          {%- caNamespace = ingressNs %}
          {%- caName = serverCa %}
        {%- end %}

        {#- Fetch secret from resource store -#}
        {%- var caSecret = resources.secrets.GetSingle(caNamespace, caName) %}
        {%- if caSecret != nil %}
          {#- Extract CA certificate content (base64 decode) -#}
          {%- var caContent = caSecret | dig("data", "ca.crt") | fallback("") | b64decode() %}
          {%- if caContent != "" %}
            {#- Register CA file with file registry and get path -#}
            {%- var caFilename = caNamespace + "-" + caName + "-ca.pem" %}
            {%- var caPath, caRegErr = fileRegistry.Register("file", caFilename, caContent) -%}
            {%- if caRegErr != nil -%}{{ fail("failed to register CA file " + caFilename + ": " + tostring(caRegErr)) }}{%- end -%}
            {#- Add server option with CA file -#}
            {%- serverOpts["flags"] = append(serverOpts["flags"].([]any), "ssl verify required ca-file " + caPath) %}
          {%- else %}
            # Warning: Secret {{ caNamespace }}/{{ caName }} missing 'ca.crt' key
          {%- end %}
        {%- else %}
          # Warning: Secret {{ caNamespace }}/{{ caName }} referenced by haproxy.org/server-ca not found
        {%- end %}
      {%- end %}

      {#- server-crt: Client certificate for mTLS -#}
      {%- var serverCrt = ingress | dig("metadata", "annotations", "haproxy.org/server-crt") | fallback("") | tostring() %}
      {%- if serverCrt != "" %}
        {#- Parse secret namespace/name (format: "namespace/secret-name") -#}
        {%- var crtNamespace = "" %}
        {%- var crtName = "" %}
        {%- if strings_contains(serverCrt, "/") %}
          {%- var crtParts = split(serverCrt, "/") %}
          {%- crtNamespace = crtParts[0] %}
          {%- crtName = crtParts[1] %}
        {%- else %}
          {#- Same namespace as ingress if not specified -#}
          {%- crtNamespace = ingressNs %}
          {%- crtName = serverCrt %}
        {%- end %}

        {#- Fetch secret from resource store -#}
        {%- var crtSecret = resources.secrets.GetSingle(crtNamespace, crtName) %}
        {%- if crtSecret != nil %}
          {#- Extract client certificate and key, combine them (HAProxy needs combined PEM) -#}
          {%- var tlsCrt = crtSecret | dig("data", "tls.crt") | fallback("") | b64decode() %}
          {%- var tlsKey = crtSecret | dig("data", "tls.key") | fallback("") | b64decode() %}
          {%- if tlsCrt != "" && tlsKey != "" %}
            {#- Combine certificate and key into single PEM file -#}
            {%- var combinedPem = tlsCrt + "\n" + tlsKey %}
            {#- Register client cert file with file registry and get path -#}
            {%- var crtFilename = crtNamespace + "-" + crtName + "-client.pem" %}
            {%- var crtPath, crtRegErr = fileRegistry.Register("cert", crtFilename, combinedPem) -%}
            {%- if crtRegErr != nil -%}{{ fail("failed to register client cert " + crtFilename + ": " + tostring(crtRegErr)) }}{%- end -%}
            {#- Add server option with client cert -#}
            {%- serverOpts["flags"] = append(serverOpts["flags"].([]any), "crt " + crtPath) %}
          {%- else %}
            # Warning: Secret {{ crtNamespace }}/{{ crtName }} missing 'tls.crt' or 'tls.key' keys
          {%- end %}
        {%- else %}
          # Warning: Secret {{ crtNamespace }}/{{ crtName }} referenced by haproxy.org/server-crt not found
        {%- end %}
      {%- end %}

      {#- scale-server-slots -#}
      {%- var serverSlots = ingress | dig("metadata", "annotations", "haproxy.org/scale-server-slots") | fallback("") | tostring() %}
      {%- if serverSlots != "" %}
        {#- Validate annotation value -#}
        {%- var serverSlotsInt = toint(serverSlots) %}
        {%- if serverSlotsInt <= 0 %}
          {%- var ingressNs = ingress | dig("metadata", "namespace") | fallback("") | tostring() %}
          {%- var ingressName = ingress | dig("metadata", "name") | fallback("") | tostring() %}
          {{- fail("Invalid value '" + serverSlots + "' for annotation 'haproxy.org/scale-server-slots' on Ingress '" + ingressNs + "/" + ingressName + "'. Must be a positive integer.") -}}
        {%- end %}
        {#- Set variable in namespace for base.yaml to use -#}
        {%- serverOpts["serverSlotsValue"] = serverSlotsInt %}
      {%- end %}

      {#- backend-config-snippet: Raw HAProxy backend directives -#}
      {%- var backendSnippet = ingress | dig("metadata", "annotations", "haproxy.org/backend-config-snippet") | fallback("") %}
      {%- if backendSnippet != "" %}
      # haproxytech/backend-config-snippet
      {{ backendSnippet }}
      {%- end %}
      {%- end -%}

  backend-directives-350-haproxytech-path-rewrite:
    template: |
      {#-
        HAProxy Path Rewrite (Ingress Only)

        Documentation: https://www.haproxy.com/documentation/kubernetes-ingress/community/configuration-reference/ingress/#path-rewrite

        Annotations:
          - haproxy.org/path-rewrite: URL path rewriting with regex (optional)

        Format:
          Single parameter: "<new-path>" (matches all paths with .*)
          Two parameters: "<regex-pattern> <replacement>" (e.g., "^/api/(.*) /v2/$1")

        Example:
          haproxy.org/path-rewrite: "^/api/v1/(.*) /$1"
          Rewrites /api/v1/users to /users

        Generated HAProxy Config:
          http-request replace-path <regex> <replacement>

        Note: This snippet requires 'ingress' variable in context (only set by Ingress backend generation)
        Note: Similar to Gateway API URLRewrite filter
      -#}
      {%- if ingress != nil %}
      {%- var pathRewrite = ingress | dig("metadata", "annotations", "haproxy.org/path-rewrite") | fallback("") | tostring() %}
      {%- if pathRewrite != "" %}
        {%- if strings_contains(pathRewrite, " ") %}
          {#- Two parameters: regex and replacement -#}
          {%- var parts = split(pathRewrite, " ") %}
          {%- var regex = parts[0] %}
          {%- var replacement = parts[1:] | join(" ") %}
      # haproxytech/backend-directives-haproxytech-path-rewrite
      http-request replace-path {{ regex }} {{ replacement }}
        {%- else %}
          {#- Single parameter: match all paths -#}
      # haproxytech/backend-directives-haproxytech-path-rewrite
      http-request replace-path (.*) {{ pathRewrite }}
        {%- end %}
      {%- end %}
      {%- end -%}

  backend-directives-300-haproxytech-header-manipulation:
    template: |
      {#-
        HAProxy Request/Response Header Manipulation (Ingress Only)

        Documentation: https://www.haproxy.com/documentation/kubernetes-ingress/community/configuration-reference/ingress/#request-set-header

        Annotations:
          - haproxy.org/request-set-header: Multiline list of "HeaderName HeaderValue" (optional)
          - haproxy.org/response-set-header: Multiline list of "HeaderName HeaderValue" (optional)

        Format:
          Each line contains: HeaderName HeaderValue
          Values are automatically quoted for HAProxy
          Header values can contain spaces (e.g., "Custom Value With Spaces")

        Example:
          haproxy.org/request-set-header: |
            X-Forwarded-Proto https
            X-Custom-Header value with spaces

        Generated HAProxy Config:
          http-request set-header HeaderName "HeaderValue"
          http-response set-header HeaderName "HeaderValue"

        Note: This snippet requires 'ingress' variable in context (only set by Ingress backend generation)
      -#}
      {%- if ingress != nil %}
      {%- var requestHeaders = ingress | dig("metadata", "annotations", "haproxy.org/request-set-header") | fallback("") | tostring() %}
      {%- var responseHeaders = ingress | dig("metadata", "annotations", "haproxy.org/response-set-header") | fallback("") | tostring() %}
      {%- if requestHeaders != "" %}
      # haproxytech/backend-directives-haproxytech-header-manipulation (request)
        {%- for _, line := range split(requestHeaders, "\n") %}
          {%- var lineTrimmed = trimSpace(line) %}
          {%- if lineTrimmed != "" && strings_contains(lineTrimmed, " ") %}
            {%- var allParts = split(lineTrimmed, " ") %}
            {%- var headerName = allParts[0] %}
            {%- var headerValue = allParts[1:] | join(" ") %}
      http-request set-header {{ headerName }} "{{ headerValue }}"
          {%- end %}
        {%- end %}
      {%- end %}
      {%- if responseHeaders != "" %}
      # haproxytech/backend-directives-haproxytech-header-manipulation (response)
        {%- for _, line := range split(responseHeaders, "\n") %}
          {%- var lineTrimmed = trimSpace(line) %}
          {%- if lineTrimmed != "" && strings_contains(lineTrimmed, " ") %}
            {%- var allParts = split(lineTrimmed, " ") %}
            {%- var headerName = allParts[0] %}
            {%- var headerValue = allParts[1:] | join(" ") %}
      http-response set-header {{ headerName }} "{{ headerValue }}"
          {%- end %}
        {%- end %}
      {%- end %}
      {%- end -%}

  backend-directives-250-haproxytech-set-host:
    template: |
      {#-
        HAProxy Set Host Header (Ingress Only)

        Documentation: https://www.haproxy.com/documentation/kubernetes-ingress/community/configuration-reference/ingress/#set-host

        Annotations:
          - haproxy.org/set-host: "<hostname>" (optional, set Host header after backend selection)

        Generated HAProxy Config:
          http-request set-header Host "<hostname>"

        Note: This happens AFTER backend selection, unlike request-set-header which happens before
        Note: This snippet requires 'ingress' variable in context (only set by Ingress backend generation)
      -#}
      {%- if ingress != nil %}
      {%- var setHost = ingress | dig("metadata", "annotations", "haproxy.org/set-host") | fallback("") | tostring() %}
      {%- if setHost != "" %}
      # haproxytech/backend-directives-haproxytech-set-host
      http-request set-header Host "{{ setHost }}"
      {%- end %}
      {%- end -%}

  backend-directives-210-haproxytech-advanced-health-checks:
    template: |
      {#-
        HAProxy Advanced Health Check Configuration (Ingress Only)

        Documentation: https://www.haproxy.com/documentation/kubernetes-ingress/community/configuration-reference/ingress/#check-http

        Annotations:
          - haproxy.org/check-http: HTTP URI or full request for health checks (optional)
          - haproxy.org/check-interval: Frequency of health checks, duration format (optional, e.g., "10s")

        Format:
          check-http: "/health" or "HEAD /health HTTP/1.1"
          check-interval: "10s", "1m", etc.

        Generated HAProxy Config:
          option httpchk GET /health
          option httpchk HEAD /health HTTP/1.1
          (applied via server inter <duration>)

        Note: This snippet requires 'ingress' variable in context (only set by Ingress backend generation)
        Note: These affect backend-level config and server-level directives
      -#}
      {%- if ingress != nil %}
      {%- var checkHttp = ingress | dig("metadata", "annotations", "haproxy.org/check-http") | fallback("") | tostring() %}
      {%- var checkInterval = ingress | dig("metadata", "annotations", "haproxy.org/check-interval") | fallback("") | tostring() %}
      {%- if checkHttp != "" %}
      # haproxytech/backend-directives-haproxytech-advanced-health-checks
        {%- if strings_contains(checkHttp, " ") %}
      option httpchk {{ checkHttp }}
        {%- else %}
      option httpchk GET {{ checkHttp }}
        {%- end %}
      {%- end %}
      {%- if checkInterval != "" %}
      # Note: check-interval annotation value: {{ checkInterval }}
      {%- end %}
      {%- end -%}

  backend-directives-200-haproxytech-health-checks:
    template: |
      {#-
        HAProxy Health Check Configuration (Ingress Only)

        Documentation: https://www.haproxy.com/documentation/kubernetes-ingress/community/configuration-reference/ingress/#check

        Annotations:
          - haproxy.org/check: "true" or "false" (optional, default: true)

        Generated HAProxy Config:
          server <name> <address>:<port> check

        Note: Health checks are enabled by default in HAProxy server directives
        Note: This snippet requires 'ingress' variable in context (only set by Ingress backend generation)
        Note: These annotations affect server-level directives which are handled by the base template
      -#}
      {%- if ingress != nil %}
      {%- var checkEnabled = ingress | dig("metadata", "annotations", "haproxy.org/check") | fallback("") | tostring() %}
      {%- if checkEnabled != "" %}
        {%- if checkEnabled != "true" && checkEnabled != "false" %}
          {%- var ingressNs = ingress | dig("metadata", "namespace") | fallback("") | tostring() %}
          {%- var ingressName = ingress | dig("metadata", "name") | fallback("") | tostring() %}
          {{- fail("Invalid value '" + checkEnabled + "' for annotation 'haproxy.org/check' on Ingress '" + ingressNs + "/" + ingressName + "'. Valid values: 'true', 'false'") -}}
        {%- end %}
      # haproxytech/backend-directives-haproxytech-health-checks
      # Note: check annotation value: {{ checkEnabled }}
      {%- end %}
      {%- end -%}

  backend-directives-100-haproxytech-pod-maxconn:
    template: |
      {#-
        HAProxy Pod MaxConn Configuration (Ingress Only)

        Documentation: https://www.haproxy.com/documentation/kubernetes-ingress/community/configuration-reference/ingress/#pod-maxconn

        Annotations:
          - haproxy.org/pod-maxconn: "<integer>" (optional, maximum connections per backend pod)

        Generated HAProxy Config:
          server <name> <address>:<port> maxconn <calculated_value>

        Note: The annotation value is automatically divided by the number of HAProxy controller pods
              to distribute the total connection limit across all replicas.

        Example:
          - Annotation value: "100"
          - HAProxy pods: 2
          - Generated maxconn: 50 (per replica)
          - Total max connections per backend pod: 100

        Note: This snippet requires 'ingress' variable in context (only set by Ingress backend generation)
        Note: This annotation affects server-level directives which are handled by the base template
      -#}
      {%- if ingress != nil %}
      {%- var podMaxconn = ingress | dig("metadata", "annotations", "haproxy.org/pod-maxconn") | fallback("") | tostring() %}
      {%- if podMaxconn != "" %}
        {#- Validate annotation value -#}
        {%- var podMaxconnInt = toint(podMaxconn) %}
        {%- if podMaxconnInt <= 0 %}
          {%- var ingressNs = ingress | dig("metadata", "namespace") | fallback("") | tostring() %}
          {%- var ingressName = ingress | dig("metadata", "name") | fallback("") | tostring() %}
          {{- fail("Invalid value '" + podMaxconn + "' for annotation 'haproxy.org/pod-maxconn' on Ingress '" + ingressNs + "/" + ingressName + "'. Must be a positive integer.") -}}
        {%- end %}

        {#- Count HAProxy controller pods -#}
        {%- var haproxyPodCount = 0 %}
        {%- if controller != nil %}
          {%- var haproxyPods = controller.haproxy_pods %}
          {%- if haproxyPods != nil %}
            {%- haproxyPodCount = len(haproxyPods.List()) %}
          {%- end %}
        {%- end %}

        {#- Calculate per-pod maxconn (divide total by pod count, with ceiling rounding) -#}
        {%- if haproxyPodCount > 0 %}
          {%- var perPodMaxconn = ((podMaxconnInt | float64()) / (haproxyPodCount | float64())) | ceil() %}
      # haproxytech/backend-directives-haproxytech-pod-maxconn
      # pod-maxconn: {{ podMaxconn }} total / {{ haproxyPodCount }} HAProxy pods = {{ perPodMaxconn }} per pod
          {#- Set variable in namespace for base.yaml to use -#}
          {% serverOpts["podMaxconnValue"] = perPodMaxconn -%}
        {%- else %}
          {#- No pods discovered yet, use full value as fallback -#}
      # haproxytech/backend-directives-haproxytech-pod-maxconn
      # pod-maxconn: {{ podMaxconn }} (no HAProxy pods discovered yet, using full value)
          {#- Set variable in namespace for base.yaml to use -#}
          {% serverOpts["podMaxconnValue"] = podMaxconnInt -%}
        {%- end %}
      {%- end %}
      {%- end -%}

  backend-directives-100-haproxytech-timeouts:
    template: |
      {#-
        HAProxy Backend Timeout Configuration (Ingress Only)

        Documentation: https://www.haproxy.com/documentation/kubernetes-ingress/community/configuration-reference/ingress/#timeout-check

        Annotations:
          - haproxy.org/timeout-server: "<duration>" (optional, default: HAProxy global/backend default)
          - haproxy.org/timeout-connect: "<duration>" (optional, default: HAProxy global/backend default)
          - haproxy.org/timeout-queue: "<duration>" (optional, default: HAProxy global/backend default)
          - haproxy.org/timeout-tunnel: "<duration>" (optional, default: HAProxy global/backend default)
          - haproxy.org/timeout-check: "<duration>" (optional, default: HAProxy global/backend default)

        Duration Format:
          HAProxy duration format: integer with optional unit suffix
          - Units: us (microseconds), ms (milliseconds), s (seconds), m (minutes), h (hours), d (days)
          - Examples: "5s", "100ms", "1m", "2h", "30s"
          - Default unit if none specified: milliseconds

        Generated HAProxy Config:
          timeout server <duration>
          timeout connect <duration>
          timeout queue <duration>
          timeout tunnel <duration>
          timeout check <duration>

        Note: These timeouts MUST be in backend context per HAProxy specification
        Note: Frontend timeouts (client, http-request, http-keep-alive) are in frontend-filters-haproxytech-timeouts
        Note: This snippet requires 'ingress' variable in context (only set by Ingress backend generation)
      -#}
      {%- if ingress != nil %}
      {%- var timeoutServer = ingress | dig("metadata", "annotations", "haproxy.org/timeout-server") | fallback("") | tostring() %}
      {%- var timeoutConnect = ingress | dig("metadata", "annotations", "haproxy.org/timeout-connect") | fallback("") | tostring() %}
      {%- var timeoutQueue = ingress | dig("metadata", "annotations", "haproxy.org/timeout-queue") | fallback("") | tostring() %}
      {%- var timeoutTunnel = ingress | dig("metadata", "annotations", "haproxy.org/timeout-tunnel") | fallback("") | tostring() %}
      {%- var timeoutCheck = ingress | dig("metadata", "annotations", "haproxy.org/timeout-check") | fallback("") | tostring() %}
      {%- if timeoutServer != "" %}
      # haproxytech/backend-directives-haproxytech-timeouts
      timeout server {{ timeoutServer }}
      {% end %}
      {%- if timeoutConnect != "" %}
      timeout connect {{ timeoutConnect }}
      {% end %}
      {%- if timeoutQueue != "" %}
      timeout queue {{ timeoutQueue }}
      {% end %}
      {%- if timeoutTunnel != "" %}
      timeout tunnel {{ timeoutTunnel }}
      {% end %}
      {%- if timeoutCheck != "" %}
      timeout check {{ timeoutCheck }}
      {% end %}
      {%- end -%}

  backend-directives-500-haproxytech-ingress-auth:
    template: |
      {#-
        HAProxy Basic Authentication - Backend Directive (Ingress Only)

        Documentation: https://www.haproxy.com/documentation/kubernetes-ingress/community/configuration-reference/ingress/#auth-secret

        Annotations:
          - haproxy.org/auth-type: "basic-auth" (triggers this template)
          - haproxy.org/auth-secret: "<secret-name>" or "<namespace>/<secret-name>"
          - haproxy.org/auth-realm: "<realm>" (optional, default: "RestrictedArea")

        Generated HAProxy Config:
          http-request auth realm "<realm>" unless { http_auth(<userlist-name>) }

        Note: Requires corresponding userlist created by global-top-haproxytech-ingress-auth
        Note: This snippet requires 'ingress' variable in context (only set by Ingress backend generation)
      -#}
      {%- if ingress != nil %}
      {%- var ingressNs = ingress | dig("metadata", "namespace") | fallback("") | tostring() %}
      {%- var ingressName = ingress | dig("metadata", "name") | fallback("") | tostring() %}
      {%- var authType = ingress | dig("metadata", "annotations", "haproxy.org/auth-type") | fallback("") | tostring() %}
      {%- if authType != "" && authType != "basic-auth" %}
        {{- fail("Invalid value '" + authType + "' for annotation 'haproxy.org/auth-type' on Ingress '" + ingressNs + "/" + ingressName + "'. Valid values: 'basic-auth'") -}}
      {%- end %}
      {%- if authType == "basic-auth" %}
        {%- var authSecret = ingress | dig("metadata", "annotations", "haproxy.org/auth-secret") | fallback("") | tostring() %}
        {#- Note: HAProxy Data Plane API's OpenAPI schema requires realm without spaces (regex: ^[^\s]+$) -#}
        {%- var authRealm = ingress | dig("metadata", "annotations", "haproxy.org/auth-realm") | fallback("RestrictedArea") | tostring() %}
        {%- if authSecret != "" %}
          {#- Generate userlist name based on secret reference -#}
          {%- var userlistName = "" %}
          {%- if strings_contains(authSecret, "/") %}
            {%- var parts = split(authSecret, "/") %}
            {%- userlistName = "auth_" + parts[0] + "_" + parts[1] %}
          {%- else %}
            {%- userlistName = "auth_" + ingressNs + "_" + authSecret %}
          {%- end %}
      # haproxytech/backend-directives-haproxytech-ingress-auth
      http-request auth realm "{{ authRealm }}" unless { http_auth({{ userlistName }}) }
        {%- end -%}
      {%- end -%}
      {%- end -%}

  features-100-haproxytech-ssl-passthrough:
    template: |
      {#-
        HAProxy SSL Passthrough Feature Registration (Ingress Only)

        Purpose:
          Scans Ingress resources to detect SSL passthrough needs and registers
          backends with the global feature registry. Uses caching to ensure
          expensive resource scanning happens only once per render.

        Flow:
          1. Scan all Ingress resources for haproxy.org/ssl-passthrough="true"
          2. Build list of passthrough backends with SNI information
          3. Register backends with globalFeatures.sslPassthroughBackends
          4. Cached analysis is reused by backends-haproxytech-ssl-passthrough

        Annotations:
          - haproxy.org/ssl-passthrough: "true" (enables passthrough for all hosts in ingress)

        Registration Format:
          {
            'name': 'ssl-passthrough-<namespace>-<name>',
            'sni': '<hostname>',
            'namespace': '<namespace>',
            'ingress': '<name>'
          }
      -#}
      {{ render "util-haproxytech-ssl-passthrough" }}

      {#- Register backends with global feature registry (only if SSL library is loaded) -#}
      {%- if shared.globalFeatures != nil %}
        {%- var globalFeatures = shared.globalFeatures.(map[string]any) %}
        {%- var sslBackends = globalFeatures | dig("sslPassthroughBackends") %}
        {%- if sslBackends != nil %}
          {%- var haproxytechBackends = shared.haproxytech_sslPassthrough.(map[string]any).backends.([]any) %}
          {%- for _, backend := range haproxytechBackends %}
            {%- globalFeatures["sslPassthroughBackends"] = append(globalFeatures["sslPassthroughBackends"].([]any), backend) %}
          {%- end %}
        {%- end %}
      {%- end %}

  backends-501-haproxytech-ssl-passthrough:
    template: |
      {#-
          HAProxy SSL Passthrough Backends (Ingress Only)

          Purpose:
            TCP backends for SSL passthrough - forward encrypted traffic directly to pods.
            No SSL termination occurs in HAProxy.
            Reuses cached analysis from features-haproxytech-ssl-passthrough via caching.

          Annotations:
            - haproxy.org/ssl-passthrough: "true" (enables passthrough for this ingress)

          Generated HAProxy Config:
            backend ssl-passthrough-<namespace>-<name>
              mode tcp
              server SRV_1 <pod-ip>:<pod-port> check

          Note: Uses util-haproxytech-ssl-passthrough for cached analysis (runs only once per render)
      -#}
      {%- import "util-backend-servers" for BackendServers -%}
      {{ render "util-haproxytech-ssl-passthrough" }}

      {%- var sslPassthroughData = shared["haproxytech_sslPassthrough"].(map[string]any) %}
      {%- var backends = sslPassthroughData["backends"].([]any) %}
      {%- for _, backendInfo := range backends %}
        {%- var beInfo = backendInfo.(map[string]any) %}
        {%- var beNs = beInfo["namespace"] | tostring() %}
        {%- var beIngress = beInfo["ingress"] | tostring() %}
        {%- var beName = beInfo["name"] | tostring() %}
        {%- var ingressKey = beNs + "/" + beIngress %}
        {%- if first_seen("sslPassthrough_backend", ingressKey) %}
          {#- Get the actual ingress resource to extract service details -#}
          {%- var ingress = resources.ingresses.GetSingle(beNs, beIngress) %}
          {%- var backendGenerated = false %}
          {%- var rules = ingress | dig("spec", "rules") | fallback([]any{}) %}
          {%- for _, rule := range rules %}
            {%- if !backendGenerated %}
              {%- var http = rule | dig("http") %}
              {%- if http != nil %}
                {%- var paths = http | dig("paths") | fallback([]any{}) %}
                {%- for _, path := range paths %}
                  {%- if !backendGenerated %}
                    {%- var serviceName = path | dig("backend", "service", "name") | fallback("") | tostring() %}
                    {%- var servicePort = path | dig("backend", "service", "port", "number") | fallback(path | dig("backend", "service", "port", "name")) | toint() %}
      # haproxytech/backends-haproxytech-ssl-passthrough

      backend {{ beName }}
          mode tcp
          balance roundrobin
          {{ BackendServers(serviceName, 10, servicePort, nil) | indent(4) }}
                    {%- backendGenerated = true %}
                  {%- end %}
                {%- end %}
              {%- end %}
            {%- end %}
          {%- end %}
        {%- end %}
      {%- end %}

validationTests:
  test-auth-basic-cross-namespace:
    description: Basic authentication with secret in different namespace
    fixtures:
      secrets:
        - apiVersion: v1
          kind: Secret
          metadata:
            namespace: auth-system
            name: shared-auth
          type: Opaque
          data:
            admin: JDJ5JDA1JG1OMVdWazVRbmJnNFF3ZEFkWGJmei44YjNjZUg2UTVLT1ZDS3hSMklrTkFmSmdMaTVwSUtX  # base64($2y$05$...) bcrypt hash
      ingresses:
        - apiVersion: networking.k8s.io/v1
          kind: Ingress
          metadata:
            namespace: production
            name: api-ingress
            annotations:
              haproxy.org/auth-type: basic-auth
              haproxy.org/auth-secret: auth-system/shared-auth
          spec:
            rules:
              - host: api.production.example.com
                http:
                  paths:
                    - path: /api
                      pathType: Prefix
                      backend:
                        service:
                          name: api-service
                          port:
                            number: 443
      services:
        - apiVersion: v1
          kind: Service
          metadata:
            namespace: production
            name: api-service
          spec:
            ports:
              - port: 443
                targetPort: 8443
      endpoints:
        - apiVersion: discovery.k8s.io/v1
          kind: EndpointSlice
          metadata:
            name: api-service-xyz789
            namespace: production
            labels:
              kubernetes.io/service-name: api-service
          addressType: IPv4
          endpoints:
            - addresses:
                - "10.0.1.5"
              targetRef:
                kind: Pod
                name: api-pod-1
          ports:
            - port: 8443
              protocol: TCP
    assertions:
      - type: haproxy_valid
        description: HAProxy configuration must be syntactically valid

      - type: contains
        target: haproxy.cfg
        pattern: "userlist auth_auth-system_shared-auth"
        description: Must generate userlist with cross-namespace naming

      - type: contains
        target: haproxy.cfg
        pattern: "user admin password"
        description: Userlist must contain credentials from cross-namespace secret

      - type: contains
        target: haproxy.cfg
        pattern: "http_auth\\(auth_auth-system_shared-auth\\)"
        description: Backend must reference cross-namespace userlist

  test-auth-custom-realm:
    description: Basic authentication with custom realm
    fixtures:
      secrets:
        - apiVersion: v1
          kind: Secret
          metadata:
            namespace: default
            name: api-auth
          type: Opaque
          data:
            apiuser: JDJ5JDA1JDJlV1VoQVU5Z0VlZ2FDZkY4Uk4xZHV1WUNrdlhoUGtpS1BDL3pkTFBvN2xNYlkxcWlUQXRP  # base64($2y$05$...) bcrypt hash
      ingresses:
        - apiVersion: networking.k8s.io/v1
          kind: Ingress
          metadata:
            namespace: default
            name: secure-api-ingress
            annotations:
              haproxy.org/auth-type: basic-auth
              haproxy.org/auth-secret: api-auth
              haproxy.org/auth-realm: "API-Access"
          spec:
            rules:
              - host: secure-api.example.com
                http:
                  paths:
                    - path: /
                      pathType: Prefix
                      backend:
                        service:
                          name: api-service
                          port:
                            number: 8080
      services:
        - apiVersion: v1
          kind: Service
          metadata:
            namespace: default
            name: api-service
          spec:
            ports:
              - port: 8080
      endpoints:
        - apiVersion: discovery.k8s.io/v1
          kind: EndpointSlice
          metadata:
            name: api-service-def456
            namespace: default
            labels:
              kubernetes.io/service-name: api-service
          addressType: IPv4
          endpoints:
            - addresses:
                - "10.0.2.10"
              targetRef:
                kind: Pod
                name: api-pod-2
          ports:
            - port: 8080
              protocol: TCP
    assertions:
      - type: haproxy_valid
        description: HAProxy configuration must be syntactically valid

      - type: contains
        target: haproxy.cfg
        pattern: 'http-request auth realm "API-Access"'
        description: Backend must use custom auth realm

      - type: not_contains
        target: haproxy.cfg
        pattern: 'realm "RestrictedArea"'
        description: Must not use default realm when custom realm specified

  test-auth-shared-userlist-deduplication:
    description: Multiple ingresses sharing same secret generate single userlist
    fixtures:
      secrets:
        - apiVersion: v1
          kind: Secret
          metadata:
            namespace: default
            name: shared-credentials
          type: Opaque
          data:
            admin: JDJ5JDA1JG1OMVdWazVRbmJnNFF3ZEFkWGJmei44YjNjZUg2UTVLT1ZDS3hSMklrTkFmSmdMaTVwSUtX  # base64($2y$05$...) bcrypt hash
      ingresses:
        - apiVersion: networking.k8s.io/v1
          kind: Ingress
          metadata:
            namespace: default
            name: app1-ingress
            annotations:
              haproxy.org/auth-type: basic-auth
              haproxy.org/auth-secret: shared-credentials
          spec:
            rules:
              - host: app1.example.com
                http:
                  paths:
                    - path: /
                      pathType: Prefix
                      backend:
                        service:
                          name: app1-service
                          port:
                            number: 80
        - apiVersion: networking.k8s.io/v1
          kind: Ingress
          metadata:
            namespace: default
            name: app2-ingress
            annotations:
              haproxy.org/auth-type: basic-auth
              haproxy.org/auth-secret: shared-credentials
          spec:
            rules:
              - host: app2.example.com
                http:
                  paths:
                    - path: /
                      pathType: Prefix
                      backend:
                        service:
                          name: app2-service
                          port:
                            number: 80
      services:
        - apiVersion: v1
          kind: Service
          metadata:
            namespace: default
            name: app1-service
          spec:
            ports:
              - port: 80
        - apiVersion: v1
          kind: Service
          metadata:
            namespace: default
            name: app2-service
          spec:
            ports:
              - port: 80
      endpoints:
        - apiVersion: discovery.k8s.io/v1
          kind: EndpointSlice
          metadata:
            name: app1-service-aaa111
            namespace: default
            labels:
              kubernetes.io/service-name: app1-service
          addressType: IPv4
          endpoints:
            - addresses:
                - "10.0.3.20"
              targetRef:
                kind: Pod
                name: app1-pod-1
          ports:
            - port: 80
              protocol: TCP
        - apiVersion: discovery.k8s.io/v1
          kind: EndpointSlice
          metadata:
            name: app2-service-bbb222
            namespace: default
            labels:
              kubernetes.io/service-name: app2-service
          addressType: IPv4
          endpoints:
            - addresses:
                - "10.0.3.21"
              targetRef:
                kind: Pod
                name: app2-pod-1
          ports:
            - port: 80
              protocol: TCP
    assertions:
      - type: haproxy_valid
        description: HAProxy configuration must be syntactically valid

      - type: contains
        target: haproxy.cfg
        pattern: "userlist auth_default_shared-credentials"
        description: Must generate shared userlist

      - type: not_contains
        target: haproxy.cfg
        pattern: "userlist auth_default_shared-credentials.*userlist auth_default_shared-credentials"
        description: Must not duplicate userlist for same secret

  test-auth-invalid-type:
    description: Invalid auth-type annotation should fail with clear error
    fixtures:
      ingresses:
        - apiVersion: networking.k8s.io/v1
          kind: Ingress
          metadata:
            namespace: default
            name: invalid-ingress
            annotations:
              haproxy.org/auth-type: digest-auth  # Invalid type
              haproxy.org/auth-secret: auth-creds
          spec:
            rules:
              - host: invalid.example.com
                http:
                  paths:
                    - path: /
                      pathType: Prefix
                      backend:
                        service:
                          port:
                            number: 80
      services:
        - apiVersion: v1
          kind: Service
          metadata:
            namespace: default
            name: invalid-service
          spec:
            ports:
              - port: 80
      endpoints:
        - apiVersion: discovery.k8s.io/v1
          kind: EndpointSlice
          metadata:
            name: invalid-service-ccc333
            namespace: default
            labels:
              kubernetes.io/service-name: invalid-service
          addressType: IPv4
          endpoints:
            - addresses:
                - "10.0.4.30"
              targetRef:
                kind: Pod
                name: invalid-pod-1
          ports:
            - port: 80
              protocol: TCP
    assertions:
      - type: contains
        target: rendering_error
        pattern: "Invalid value 'digest-auth' for annotation 'haproxy.org/auth-type'"
        description: Must fail with clear error for invalid auth type

      - type: contains
        target: rendering_error
        pattern: "Valid values: 'basic-auth'"
        description: Error must indicate valid auth type values

  test-auth-missing-secret:
    description: Missing auth secret should fail with clear error
    fixtures:
      secrets: [ ]  # No secrets defined
      ingresses:
        - apiVersion: networking.k8s.io/v1
          kind: Ingress
          metadata:
            namespace: default
            name: missing-secret-ingress
            annotations:
              haproxy.org/auth-type: basic-auth
              haproxy.org/auth-secret: nonexistent-secret
          spec:
            rules:
              - host: missing.example.com
                http:
                  paths:
                    - path: /
                      pathType: Prefix
                      backend:
                        service:
                          port:
                            number: 80
      services:
        - apiVersion: v1
          kind: Service
          metadata:
            namespace: default
            name: missing-secret-service
          spec:
            ports:
              - port: 80
      endpoints:
        - apiVersion: discovery.k8s.io/v1
          kind: EndpointSlice
          metadata:
            name: missing-secret-service-ddd444
            namespace: default
            labels:
              kubernetes.io/service-name: missing-secret-service
          addressType: IPv4
          endpoints:
            - addresses:
                - "10.0.5.40"
              targetRef:
                kind: Pod
                name: missing-secret-pod-1
          ports:
            - port: 80
              protocol: TCP
    assertions:
      - type: contains
        target: rendering_error
        pattern: "Secret 'default/nonexistent-secret'.*does not exist"
        description: Must fail with clear error for missing secret

      - type: contains
        target: rendering_error
        pattern: "Please create the secret or update the annotation"
        description: Error must provide actionable guidance

  test-timeouts-valid:
    description: Valid timeout values with various duration formats
    fixtures:
      ingresses:
        - apiVersion: networking.k8s.io/v1
          kind: Ingress
          metadata:
            namespace: default
            name: timeout-ingress
            annotations:
              haproxy.org/timeout-server: "30s"
              haproxy.org/timeout-client: "60s"
              haproxy.org/timeout-connect: "10s"
              haproxy.org/timeout-http-request: "5s"
              haproxy.org/timeout-http-keep-alive: "2m"
              haproxy.org/timeout-queue: "15s"
              haproxy.org/timeout-tunnel: "1h"
              haproxy.org/timeout-check: "3s"
          spec:
            rules:
              - host: timeout.example.com
                http:
                  paths:
                    - path: /
                      pathType: Prefix
                      backend:
                        service:
                          name: timeout-service
                          port:
                            number: 8080
      services:
        - apiVersion: v1
          kind: Service
          metadata:
            namespace: default
            name: timeout-service
          spec:
            ports:
              - port: 8080
      endpoints:
        - apiVersion: discovery.k8s.io/v1
          kind: EndpointSlice
          metadata:
            name: timeout-service-abc123
            namespace: default
            labels:
              kubernetes.io/service-name: timeout-service
          addressType: IPv4
          endpoints:
            - addresses:
                - "10.0.6.50"
              targetRef:
                kind: Pod
                name: timeout-pod-1
          ports:
            - port: 8080
              protocol: TCP
    assertions:
      - type: haproxy_valid
        description: HAProxy configuration must be syntactically valid

      - type: contains
        target: haproxy.cfg
        pattern: "timeout server 30s"
        description: Must generate timeout server directive

      - type: contains
        target: haproxy.cfg
        pattern: "timeout client 60s"
        description: Must generate timeout client directive

      - type: contains
        target: haproxy.cfg
        pattern: "timeout connect 10s"
        description: Must generate timeout connect directive

      - type: contains
        target: haproxy.cfg
        pattern: "timeout http-request 5s"
        description: Must generate timeout http-request directive

      - type: contains
        target: haproxy.cfg
        pattern: "timeout http-keep-alive 2m"
        description: Must generate timeout http-keep-alive directive

      - type: contains
        target: haproxy.cfg
        pattern: "timeout queue 15s"
        description: Must generate timeout queue directive

      - type: contains
        target: haproxy.cfg
        pattern: "timeout tunnel 1h"
        description: Must generate timeout tunnel directive

      - type: contains
        target: haproxy.cfg
        pattern: "timeout check 3s"
        description: Must generate timeout check directive

  test-timeouts-partial:
    description: Ingress with only some timeouts configured
    fixtures:
      ingresses:
        - apiVersion: networking.k8s.io/v1
          kind: Ingress
          metadata:
            namespace: default
            name: partial-timeout-ingress
            annotations:
              haproxy.org/timeout-server: "45s"
              haproxy.org/timeout-connect: "8s"
          spec:
            rules:
              - host: partial-timeout.example.com
                http:
                  paths:
                    - path: /
                      pathType: Prefix
                      backend:
                        service:
                          name: partial-timeout-service
                          port:
                            number: 80
      services:
        - apiVersion: v1
          kind: Service
          metadata:
            namespace: default
            name: partial-timeout-service
          spec:
            ports:
              - port: 80
      endpoints:
        - apiVersion: discovery.k8s.io/v1
          kind: EndpointSlice
          metadata:
            name: partial-timeout-service-def456
            namespace: default
            labels:
              kubernetes.io/service-name: partial-timeout-service
          addressType: IPv4
          endpoints:
            - addresses:
                - "10.0.7.60"
              targetRef:
                kind: Pod
                name: partial-timeout-pod-1
          ports:
            - port: 80
              protocol: TCP
    assertions:
      - type: haproxy_valid
        description: HAProxy configuration must be syntactically valid

      - type: contains
        target: haproxy.cfg
        pattern: "timeout server 45s"
        description: Must generate configured timeout server directive

      - type: contains
        target: haproxy.cfg
        pattern: "timeout connect 8s"
        description: Must generate configured timeout connect directive

  test-load-balance-leastconn:
    description: Load balancing with leastconn algorithm
    fixtures:
      ingresses:
        - apiVersion: networking.k8s.io/v1
          kind: Ingress
          metadata:
            namespace: default
            name: lb-ingress
            annotations:
              haproxy.org/load-balance: leastconn
          spec:
            rules:
              - host: lb.example.com
                http:
                  paths:
                    - path: /
                      pathType: Prefix
                      backend:
                        service:
                          name: lb-service
                          port:
                            number: 8080
      services:
        - apiVersion: v1
          kind: Service
          metadata:
            namespace: default
            name: lb-service
          spec:
            ports:
              - port: 8080
      endpoints:
        - apiVersion: discovery.k8s.io/v1
          kind: EndpointSlice
          metadata:
            name: lb-service-xyz
            namespace: default
            labels:
              kubernetes.io/service-name: lb-service
          addressType: IPv4
          endpoints:
            - addresses:
                - "10.0.8.70"
              targetRef:
                kind: Pod
                name: lb-pod-1
          ports:
            - port: 8080
              protocol: TCP
    assertions:
      - type: haproxy_valid
        description: HAProxy configuration must be syntactically valid

      - type: contains
        target: haproxy.cfg
        pattern: "balance leastconn"
        description: Must generate balance leastconn directive

  test-load-balance-invalid:
    description: Invalid load balancing algorithm should fail with clear error
    fixtures:
      ingresses:
        - apiVersion: networking.k8s.io/v1
          kind: Ingress
          metadata:
            namespace: default
            name: invalid-lb-ingress
            annotations:
              haproxy.org/load-balance: invalid-algorithm
          spec:
            rules:
              - host: invalid-lb.example.com
                http:
                  paths:
                    - path: /
                      pathType: Prefix
                      backend:
                        service:
                          name: invalid-lb-service
                          port:
                            number: 80
      services:
        - apiVersion: v1
          kind: Service
          metadata:
            namespace: default
            name: invalid-lb-service
          spec:
            ports:
              - port: 80
      endpoints:
        - apiVersion: discovery.k8s.io/v1
          kind: EndpointSlice
          metadata:
            name: invalid-lb-service-abc
            namespace: default
            labels:
              kubernetes.io/service-name: invalid-lb-service
          addressType: IPv4
          endpoints:
            - addresses:
                - "10.0.9.80"
              targetRef:
                kind: Pod
                name: invalid-lb-pod-1
          ports:
            - port: 80
              protocol: TCP
    assertions:
      - type: contains
        target: rendering_error
        pattern: "Invalid value 'invalid-algorithm' for annotation 'haproxy.org/load-balance'"
        description: Must fail with clear error for invalid algorithm

      - type: contains
        target: rendering_error
        pattern: "Valid values: roundrobin, leastconn, source, uri, hdr, random, rdp-cookie"
        description: Error must indicate valid algorithm values

  test-forwarded-for-enabled:
    description: Forwarded-for enabled adds X-Forwarded-For header
    fixtures:
      ingresses:
        - apiVersion: networking.k8s.io/v1
          kind: Ingress
          metadata:
            namespace: default
            name: forwarded-for-ingress
            annotations:
              haproxy.org/forwarded-for: "true"
          spec:
            rules:
              - host: forwarded-for.example.com
                http:
                  paths:
                    - path: /
                      pathType: Prefix
                      backend:
                        service:
                          name: forwarded-for-service
                          port:
                            number: 8080
      services:
        - apiVersion: v1
          kind: Service
          metadata:
            namespace: default
            name: forwarded-for-service
          spec:
            ports:
              - port: 8080
      endpoints:
        - apiVersion: discovery.k8s.io/v1
          kind: EndpointSlice
          metadata:
            name: forwarded-for-service-abc
            namespace: default
            labels:
              kubernetes.io/service-name: forwarded-for-service
          addressType: IPv4
          endpoints:
            - addresses:
                - "10.0.10.90"
              targetRef:
                kind: Pod
                name: forwarded-for-pod-1
          ports:
            - port: 8080
              protocol: TCP
    assertions:
      - type: haproxy_valid
        description: HAProxy configuration must be syntactically valid

      - type: contains
        target: haproxy.cfg
        pattern: "option forwardfor"
        description: Must generate option forwardfor directive

  test-set-host-header:
    description: Set-host annotation modifies Host header
    fixtures:
      ingresses:
        - apiVersion: networking.k8s.io/v1
          kind: Ingress
          metadata:
            namespace: default
            name: set-host-ingress
            annotations:
              haproxy.org/set-host: "internal-api.example.svc.cluster.local"
          spec:
            rules:
              - host: api.example.com
                http:
                  paths:
                    - path: /
                      pathType: Prefix
                      backend:
                        service:
                          name: set-host-service
                          port:
                            number: 8080
      services:
        - apiVersion: v1
          kind: Service
          metadata:
            namespace: default
            name: set-host-service
          spec:
            ports:
              - port: 8080
      endpoints:
        - apiVersion: discovery.k8s.io/v1
          kind: EndpointSlice
          metadata:
            name: set-host-service-xyz
            namespace: default
            labels:
              kubernetes.io/service-name: set-host-service
          addressType: IPv4
          endpoints:
            - addresses:
                - "10.0.11.100"
              targetRef:
                kind: Pod
                name: set-host-pod-1
          ports:
            - port: 8080
              protocol: TCP
    assertions:
      - type: haproxy_valid
        description: HAProxy configuration must be syntactically valid

      - type: contains
        target: haproxy.cfg
        pattern: 'http-request set-header Host "internal-api.example.svc.cluster.local"'
        description: Must generate http-request set-header Host directive

  test-health-check-annotations:
    description: Health check annotations are documented in config
    fixtures:
      ingresses:
        - apiVersion: networking.k8s.io/v1
          kind: Ingress
          metadata:
            namespace: default
            name: health-check-ingress
            annotations:
              haproxy.org/check: "true"
              haproxy.org/pod-maxconn: "100"
          spec:
            rules:
              - host: health-check.example.com
                http:
                  paths:
                    - path: /
                      pathType: Prefix
                      backend:
                        service:
                          name: health-check-service
                          port:
                            number: 8080
      services:
        - apiVersion: v1
          kind: Service
          metadata:
            namespace: default
            name: health-check-service
          spec:
            ports:
              - port: 8080
      endpoints:
        - apiVersion: discovery.k8s.io/v1
          kind: EndpointSlice
          metadata:
            name: health-check-service-abc
            namespace: default
            labels:
              kubernetes.io/service-name: health-check-service
          addressType: IPv4
          endpoints:
            - addresses:
                - "10.0.12.110"
              targetRef:
                kind: Pod
                name: health-check-pod-1
          ports:
            - port: 8080
              protocol: TCP
    assertions:
      - type: haproxy_valid
        description: HAProxy configuration must be syntactically valid

      - type: contains
        target: haproxy.cfg
        pattern: "# Note: check annotation value: true"
        description: Must document check annotation value

      - type: contains
        target: haproxy.cfg
        pattern: "# pod-maxconn: 100"
        description: Must configure pod-maxconn

      - type: contains
        target: haproxy.cfg
        pattern: "maxconn 100"
        description: Must generate maxconn server parameter

  test-header-manipulation:
    description: Request and response header manipulation
    fixtures:
      ingresses:
        - apiVersion: networking.k8s.io/v1
          kind: Ingress
          metadata:
            namespace: default
            name: headers-ingress
            annotations:
              haproxy.org/request-set-header: |
                X-Forwarded-Proto https
                X-Custom-Request custom-req-value
              haproxy.org/response-set-header: |
                Strict-Transport-Security max-age=31536000
                X-Custom-Response custom-resp-value
          spec:
            rules:
              - host: headers.example.com
                http:
                  paths:
                    - path: /
                      pathType: Prefix
                      backend:
                        service:
                          name: headers-service
                          port:
                            number: 8080
      services:
        - apiVersion: v1
          kind: Service
          metadata:
            namespace: default
            name: headers-service
          spec:
            ports:
              - port: 8080
      endpoints:
        - apiVersion: discovery.k8s.io/v1
          kind: EndpointSlice
          metadata:
            name: headers-service-abc
            namespace: default
            labels:
              kubernetes.io/service-name: headers-service
          addressType: IPv4
          endpoints:
            - addresses:
                - "10.0.13.120"
              targetRef:
                kind: Pod
                name: headers-pod-1
          ports:
            - port: 8080
              protocol: TCP
    assertions:
      - type: haproxy_valid
        description: HAProxy configuration must be syntactically valid

      - type: contains
        target: haproxy.cfg
        pattern: 'http-request set-header X-Forwarded-Proto "https"'
        description: Must generate request header directive

      - type: contains
        target: haproxy.cfg
        pattern: 'http-response set-header Strict-Transport-Security "max-age=31536000"'
        description: Must generate response header directive

  test-access-control-allowlist:
    description: IP allowlist access control
    fixtures:
      ingresses:
        - apiVersion: networking.k8s.io/v1
          kind: Ingress
          metadata:
            namespace: default
            name: allowlist-ingress
            annotations:
              haproxy.org/allowlist: "192.168.1.0/24, 10.0.0.1"
          spec:
            rules:
              - host: allowlist.example.com
                http:
                  paths:
                    - path: /
                      pathType: Prefix
                      backend:
                        service:
                          name: allowlist-service
                          port:
                            number: 8080
      services:
        - apiVersion: v1
          kind: Service
          metadata:
            namespace: default
            name: allowlist-service
          spec:
            ports:
              - port: 8080
      endpoints:
        - apiVersion: discovery.k8s.io/v1
          kind: EndpointSlice
          metadata:
            name: allowlist-service-abc
            namespace: default
            labels:
              kubernetes.io/service-name: allowlist-service
          addressType: IPv4
          endpoints:
            - addresses:
                - "10.0.14.130"
              targetRef:
                kind: Pod
                name: allowlist-pod-1
          ports:
            - port: 8080
              protocol: TCP
    assertions:
      - type: haproxy_valid
        description: HAProxy configuration must be syntactically valid

      - type: contains
        target: haproxy.cfg
        pattern: "acl haproxytech_allowlist_default_allowlist-ingress src 192\\.168\\.1\\.0/24 10\\.0\\.0\\.1"
        description: Must generate single ACL with both CIDR and IP

      - type: contains
        target: haproxy.cfg
        pattern: "http-request deny if \\{ var\\(txn\\.host\\) -m str allowlist\\.example\\.com \\} !haproxytech_allowlist_default_allowlist-ingress"
        description: Must generate deny rule for non-allowlisted IPs

  test-cors-enabled:
    description: CORS configuration with multiple headers
    fixtures:
      ingresses:
        - apiVersion: networking.k8s.io/v1
          kind: Ingress
          metadata:
            namespace: default
            name: cors-ingress
            annotations:
              haproxy.org/cors-enable: "true"
              haproxy.org/cors-allow-origin: "https://example.com"
              haproxy.org/cors-allow-methods: "GET, POST, PUT, DELETE"
              haproxy.org/cors-allow-headers: "Content-Type, Authorization"
              haproxy.org/cors-allow-credentials: "true"
              haproxy.org/cors-max-age: "3600"
          spec:
            rules:
              - host: cors.example.com
                http:
                  paths:
                    - path: /api
                      pathType: Prefix
                      backend:
                        service:
                          name: cors-service
                          port:
                            number: 8080
      services:
        - apiVersion: v1
          kind: Service
          metadata:
            namespace: default
            name: cors-service
          spec:
            ports:
              - port: 8080
      endpoints:
        - apiVersion: discovery.k8s.io/v1
          kind: EndpointSlice
          metadata:
            name: cors-service-abc
            namespace: default
            labels:
              kubernetes.io/service-name: cors-service
          addressType: IPv4
          endpoints:
            - addresses:
                - "10.0.15.140"
              targetRef:
                kind: Pod
                name: cors-pod-1
          ports:
            - port: 8080
              protocol: TCP
    assertions:
      - type: haproxy_valid
        description: HAProxy configuration must be syntactically valid

      - type: contains
        target: haproxy.cfg
        pattern: 'http-response set-header Access-Control-Allow-Origin "https://example.com"'
        description: Must set CORS origin header

      - type: contains
        target: haproxy.cfg
        pattern: 'http-response set-header Access-Control-Allow-Credentials "true"'
        description: Must set CORS credentials header

  test-rate-limiting:
    description: Rate limiting with custom configuration
    fixtures:
      ingresses:
        - apiVersion: networking.k8s.io/v1
          kind: Ingress
          metadata:
            namespace: default
            name: ratelimit-ingress
            annotations:
              haproxy.org/rate-limit-requests: "100"
              haproxy.org/rate-limit-period: "1m"
              haproxy.org/rate-limit-size: "100k"
              haproxy.org/rate-limit-status-code: "429"
          spec:
            rules:
              - host: ratelimit.example.com
                http:
                  paths:
                    - path: /
                      pathType: Prefix
                      backend:
                        service:
                          name: ratelimit-service
                          port:
                            number: 8080
      services:
        - apiVersion: v1
          kind: Service
          metadata:
            namespace: default
            name: ratelimit-service
          spec:
            ports:
              - port: 8080
      endpoints:
        - apiVersion: discovery.k8s.io/v1
          kind: EndpointSlice
          metadata:
            name: ratelimit-service-abc
            namespace: default
            labels:
              kubernetes.io/service-name: ratelimit-service
          addressType: IPv4
          endpoints:
            - addresses:
                - "10.0.16.150"
              targetRef:
                kind: Pod
                name: ratelimit-pod-1
          ports:
            - port: 8080
              protocol: TCP
    assertions:
      - type: haproxy_valid
        description: HAProxy configuration must be syntactically valid

      - type: contains
        target: haproxy.cfg
        pattern: "stick-table type ip size 100k expire 1m"
        description: Must generate stick-table for rate limiting

      - type: contains
        target: haproxy.cfg
        pattern: "http-request deny deny_status 429 if"
        description: Must deny with custom status code

  test-ssl-redirect:
    description: SSL redirect forces HTTPS
    fixtures:
      ingresses:
        - apiVersion: networking.k8s.io/v1
          kind: Ingress
          metadata:
            namespace: default
            name: ssl-redirect-ingress
            annotations:
              haproxy.org/ssl-redirect: "true"
              haproxy.org/ssl-redirect-code: "301"
          spec:
            rules:
              - host: ssl-redirect.example.com
                http:
                  paths:
                    - path: /
                      pathType: Prefix
                      backend:
                        service:
                          name: ssl-redirect-service
                          port:
                            number: 8080
      services:
        - apiVersion: v1
          kind: Service
          metadata:
            namespace: default
            name: ssl-redirect-service
          spec:
            ports:
              - port: 8080
      endpoints:
        - apiVersion: discovery.k8s.io/v1
          kind: EndpointSlice
          metadata:
            name: ssl-redirect-service-abc
            namespace: default
            labels:
              kubernetes.io/service-name: ssl-redirect-service
          addressType: IPv4
          endpoints:
            - addresses:
                - "10.0.17.160"
              targetRef:
                kind: Pod
                name: ssl-redirect-pod-1
          ports:
            - port: 8080
              protocol: TCP
    assertions:
      - type: haproxy_valid
        description: HAProxy configuration must be syntactically valid

      - type: contains
        target: haproxy.cfg
        pattern: "http-request redirect scheme https code 301"
        description: Must generate SSL redirect directive

  test-path-rewrite:
    description: Path rewriting with regex
    fixtures:
      ingresses:
        - apiVersion: networking.k8s.io/v1
          kind: Ingress
          metadata:
            namespace: default
            name: pathrewrite-ingress
            annotations:
              haproxy.org/path-rewrite: "^/api/v1/(.*) /$1"
          spec:
            rules:
              - host: pathrewrite.example.com
                http:
                  paths:
                    - path: /api/v1
                      pathType: Prefix
                      backend:
                        service:
                          name: pathrewrite-service
                          port:
                            number: 8080
      services:
        - apiVersion: v1
          kind: Service
          metadata:
            namespace: default
            name: pathrewrite-service
          spec:
            ports:
              - port: 8080
      endpoints:
        - apiVersion: discovery.k8s.io/v1
          kind: EndpointSlice
          metadata:
            name: pathrewrite-service-abc
            namespace: default
            labels:
              kubernetes.io/service-name: pathrewrite-service
          addressType: IPv4
          endpoints:
            - addresses:
                - "10.0.18.170"
              targetRef:
                kind: Pod
                name: pathrewrite-pod-1
          ports:
            - port: 8080
              protocol: TCP
    assertions:
      - type: haproxy_valid
        description: HAProxy configuration must be syntactically valid

      - type: contains
        target: haproxy.cfg
        pattern: 'http-request replace-path'
        description: Must generate path rewrite directive

      - type: contains
        target: haproxy.cfg
        pattern: '/api/v1'
        description: Must reference API path

  test-advanced-health-checks:
    description: Advanced health check configuration
    fixtures:
      ingresses:
        - apiVersion: networking.k8s.io/v1
          kind: Ingress
          metadata:
            namespace: default
            name: healthcheck-ingress
            annotations:
              haproxy.org/check: "true"
              haproxy.org/check-http: "/health"
              haproxy.org/check-interval: "5s"
          spec:
            rules:
              - host: healthcheck.example.com
                http:
                  paths:
                    - path: /
                      pathType: Prefix
                      backend:
                        service:
                          name: healthcheck-service
                          port:
                            number: 8080
      services:
        - apiVersion: v1
          kind: Service
          metadata:
            namespace: default
            name: healthcheck-service
          spec:
            ports:
              - port: 8080
      endpoints:
        - apiVersion: discovery.k8s.io/v1
          kind: EndpointSlice
          metadata:
            name: healthcheck-service-abc
            namespace: default
            labels:
              kubernetes.io/service-name: healthcheck-service
          addressType: IPv4
          endpoints:
            - addresses:
                - "10.0.20.100"
              targetRef:
                kind: Pod
                name: healthcheck-pod-1
          ports:
            - port: 8080
              protocol: TCP
    assertions:
      - type: haproxy_valid
        description: HAProxy configuration must be syntactically valid

      - type: contains
        target: haproxy.cfg
        pattern: "option httpchk GET /health"
        description: Must generate HTTP health check with custom path

  test-source-ip-logging:
    description: Source IP header and request capture
    fixtures:
      ingresses:
        - apiVersion: networking.k8s.io/v1
          kind: Ingress
          metadata:
            namespace: default
            name: logging-ingress
            annotations:
              haproxy.org/src-ip-header: "X-Real-IP"
              haproxy.org/request-capture: "User-Agent"
              haproxy.org/request-capture-len: "128"
          spec:
            rules:
              - host: logging.example.com
                http:
                  paths:
                    - path: /
                      pathType: Prefix
                      backend:
                        service:
                          name: logging-service
                          port:
                            number: 8080
      services:
        - apiVersion: v1
          kind: Service
          metadata:
            namespace: default
            name: logging-service
          spec:
            ports:
              - port: 8080
      endpoints:
        - apiVersion: discovery.k8s.io/v1
          kind: EndpointSlice
          metadata:
            name: logging-service-abc
            namespace: default
            labels:
              kubernetes.io/service-name: logging-service
          addressType: IPv4
          endpoints:
            - addresses:
                - "10.0.21.100"
              targetRef:
                kind: Pod
                name: logging-pod-1
          ports:
            - port: 8080
              protocol: TCP
    assertions:
      - type: haproxy_valid
        description: HAProxy configuration must be syntactically valid

      - type: contains
        target: haproxy.cfg
        pattern: 'http-request set-src'
        description: Must extract source IP from header

      - type: contains
        target: haproxy.cfg
        pattern: 'X-Real-IP'
        description: Must reference X-Real-IP header

      - type: contains
        target: haproxy.cfg
        pattern: "capture request header User-Agent len 128"
        description: Must generate request capture directive

  test-access-control-denylist:
    description: Access control with deny-list
    fixtures:
      ingresses:
        - apiVersion: networking.k8s.io/v1
          kind: Ingress
          metadata:
            namespace: default
            name: denylist-ingress
            annotations:
              haproxy.org/denylist: "192.168.1.100, 192.168.1.101"
          spec:
            rules:
              - host: denylist.example.com
                http:
                  paths:
                    - path: /
                      pathType: Prefix
                      backend:
                        service:
                          name: denylist-service
                          port:
                            number: 8080
      services:
        - apiVersion: v1
          kind: Service
          metadata:
            namespace: default
            name: denylist-service
          spec:
            ports:
              - port: 8080
      endpoints:
        - apiVersion: discovery.k8s.io/v1
          kind: EndpointSlice
          metadata:
            name: denylist-service-abc
            namespace: default
            labels:
              kubernetes.io/service-name: denylist-service
          addressType: IPv4
          endpoints:
            - addresses:
                - "10.0.22.100"
              targetRef:
                kind: Pod
                name: denylist-pod-1
          ports:
            - port: 8080
              protocol: TCP
    assertions:
      - type: haproxy_valid
        description: HAProxy configuration must be syntactically valid

      - type: contains
        target: haproxy.cfg
        pattern: "acl haproxytech_denylist_default_denylist-ingress src 192\\.168\\.1\\.100 192\\.168\\.1\\.101"
        description: Must generate single ACL with both IPs

      - type: contains
        target: haproxy.cfg
        pattern: "http-request deny if \\{ var\\(txn\\.host\\) -m str denylist\\.example\\.com \\} haproxytech_denylist_default_denylist-ingress"
        description: Must generate deny rule with host condition and single ACL

  test-request-redirect:
    description: Request redirection with custom code
    fixtures:
      ingresses:
        - apiVersion: networking.k8s.io/v1
          kind: Ingress
          metadata:
            namespace: default
            name: redirect-ingress
            annotations:
              haproxy.org/request-redirect: "https://new.example.com"
              haproxy.org/request-redirect-code: "302"
          spec:
            rules:
              - host: old.example.com
                http:
                  paths:
                    - path: /
                      pathType: Prefix
                      backend:
                        service:
                          name: redirect-service
                          port:
                            number: 8080
      services:
        - apiVersion: v1
          kind: Service
          metadata:
            namespace: default
            name: redirect-service
          spec:
            ports:
              - port: 8080
      endpoints:
        - apiVersion: discovery.k8s.io/v1
          kind: EndpointSlice
          metadata:
            name: redirect-service-abc
            namespace: default
            labels:
              kubernetes.io/service-name: redirect-service
          addressType: IPv4
          endpoints:
            - addresses:
                - "10.0.23.100"
              targetRef:
                kind: Pod
                name: redirect-pod-1
          ports:
            - port: 8080
              protocol: TCP
    assertions:
      - type: haproxy_valid
        description: HAProxy configuration must be syntactically valid

      - type: contains
        target: haproxy.cfg
        pattern: "http-request redirect location https://new.example.com code 302"
        description: Must generate redirect with custom code

  test-session-persistence:
    description: Cookie-based session persistence
    fixtures:
      ingresses:
        - apiVersion: networking.k8s.io/v1
          kind: Ingress
          metadata:
            namespace: default
            name: session-ingress
            annotations:
              haproxy.org/cookie-persistence: "SESSION"
          spec:
            rules:
              - host: session.example.com
                http:
                  paths:
                    - path: /
                      pathType: Prefix
                      backend:
                        service:
                          name: session-service
                          port:
                            number: 8080
      services:
        - apiVersion: v1
          kind: Service
          metadata:
            namespace: default
            name: session-service
          spec:
            ports:
              - port: 8080
      endpoints:
        - apiVersion: discovery.k8s.io/v1
          kind: EndpointSlice
          metadata:
            name: session-service-abc
            namespace: default
            labels:
              kubernetes.io/service-name: session-service
          addressType: IPv4
          endpoints:
            - addresses:
                - "10.0.24.100"
              targetRef:
                kind: Pod
                name: session-pod-1
          ports:
            - port: 8080
              protocol: TCP
    assertions:
      - type: haproxy_valid
        description: HAProxy configuration must be syntactically valid

      - type: contains
        target: haproxy.cfg
        pattern: "cookie SESSION insert indirect nocache"
        description: Must generate cookie persistence directive

  test-backend-ssl:
    description: Backend SSL/TLS configuration
    fixtures:
      ingresses:
        - apiVersion: networking.k8s.io/v1
          kind: Ingress
          metadata:
            namespace: default
            name: backendssl-ingress
            annotations:
              haproxy.org/server-ssl: "true"
              haproxy.org/server-proto: "h2"
          spec:
            rules:
              - host: backendssl.example.com
                http:
                  paths:
                    - path: /
                      pathType: Prefix
                      backend:
                        service:
                          name: backendssl-service
                          port:
                            number: 8443
      services:
        - apiVersion: v1
          kind: Service
          metadata:
            namespace: default
            name: backendssl-service
          spec:
            ports:
              - port: 8443
      endpoints:
        - apiVersion: discovery.k8s.io/v1
          kind: EndpointSlice
          metadata:
            name: backendssl-service-abc
            namespace: default
            labels:
              kubernetes.io/service-name: backendssl-service
          addressType: IPv4
          endpoints:
            - addresses:
                - "10.0.25.100"
              targetRef:
                kind: Pod
                name: backendssl-pod-1
          ports:
            - port: 8443
              protocol: TCP
    assertions:
      - type: haproxy_valid
        description: HAProxy configuration must be syntactically valid

      - type: contains
        target: haproxy.cfg
        pattern: "backend ing_default_backendssl-ingress_backendssl-service_8443"
        description: Backend must be generated

      - type: contains
        target: haproxy.cfg
        pattern: "server SRV_1 10.0.25.100:8443 ssl verify none proto h2 check"
        description: Server must include SSL and proto directives

  test-backend-mtls:
    description: Backend mTLS with client certificate and CA verification
    fixtures:
      secrets:
        - apiVersion: v1
          kind: Secret
          metadata:
            namespace: default
            name: backend-mtls-ca
          type: Opaque
          data:
            ca.crt: LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUREekNDQWZlZ0F3SUJBZ0lVTGJRKzlYeUFDbk9CS0xRZlhrMGFWeVlrWllzd0RRWUpLb1pJaHZjTkFRRUwKQlFBd0Z6RVZNQk1HQTFVRUF3d01SR1Z0YnlCdFZFeFRJRU5CTUI0WERUSTFNVEV3T0RFM016SXlOVm9YRFRJMgpNVEV3T0RFM016SXlOVm93RnpFVk1CTUdBMVVFQXd3TVJHVnRieUJ0VkV4VElFTkJNSUlCSWpBTkJna3Foa2lHCjl3MEJBUUVGQUFPQ0FROEFNSUlCQ2dLQ0FRRUFwdmdhNkl5cmRuN1pXUkI4UjJFZm9hSmF6Q1B5RjdObS9ZeVMKNk5RSVJhZzdCTVR1Z0RUTml5bmh2Mmx3TG14c2xyNmtncXdieEo0TkZETWRxK3pnVGNmbFFpRjE5N1lsbnlPVAovRzZPMVVNNitOLzQyMmpKYlFOeHI4bTh2TThVN0FkUXU0ek5MREtwZU9YbVo3c2ZWWDI3ZVNqUENmR2drWTl3CjI3c3JubXY4UzVGanVhRlBVbkxHSzBVUWhWRTlIcE5scC91cHhyUmQzOUNDOUFWZlN6WWUvNGNjay9yYVBoZDAKSkhCa1NEWDdmWkY5aE1UQXNsdHdUSGp4KzFQNHF4T3BFeGd6MHNTQ0dPVjNHRHRocmhKZndMaU5RZU1nQXdWawpzRWxUN095M2d1WGxVS3UxRVhvN1dnMTBOOXkzRjRyWURPa1p0c2loWVlOM3VvaEM3UUlEQVFBQm8xTXdVVEFkCkJnTlZIUTRFRmdRVWo4NWRiaXBQR2ZWMzVOeWJIdGlpd2NwNG9kRXdId1lEVlIwakJCZ3dGb0FVajg1ZGJpcFAKR2ZWMzVOeWJIdGlpd2NwNG9kRXdEd1lEVlIwVEFRSC9CQVV3QXdFQi96QU5CZ2txaGtpRzl3MEJBUXNGQUFPQwpBUUVBbCtXOUtLQ3hCOXpXQ1kxZ0t0TVJGU0FtRUNVODNwaDlrRVVMMnZJdklMLzBOMEJQZjFtWjV4S1BUL0hQClZYZE9YTFg5aTJGYi9xMndKSEtQNVNVYzBqaFVYK2NlVHA3TDhJNjdmWXpxYUd2cVIxY3dCQWh2eW9RV0U1NysKTkszRFo3L3NFT3BCNFdmR2hycEJiZ1FZUTVSb3h0c3A0aTV4UFJJaktha2tuZzJDdXg4bEpYT29sZ3ZIRm5FMgpBRys3Vit0d0JJbVhtUDNyRzB1QmliSVE4M1NmOUNmWG5IbEJqOVlJSUJ3MHE5Rk5Md2duai9CUkpwRXM0OERnCm9VUkZMd1VFWmxLTkZLWld2dGhMVTJrOGdteFQxc3dmd01BMW1zcmF4SUpCZEZMZkdDS1pWanpxWllRRFdPcHcKdjF4eC9sQmVVMDV5UVhxc3B6dU04THpyVFE9PQotLS0tLUVORCBDRVJUSUZJQ0FURS0tLS0tCg==

        - apiVersion: v1
          kind: Secret
          metadata:
            namespace: default
            name: backend-mtls-client-cert
          type: kubernetes.io/tls
          data:
            tls.crt: LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSURBRENDQWVpZ0F3SUJBZ0lVVVFFNHBtcy9lQnJKamM4WmVyclpyd3hNSW1Jd0RRWUpLb1pJaHZjTkFRRUwKQlFBd0Z6RVZNQk1HQTFVRUF3d01SR1Z0YnlCdFZFeFRJRU5CTUI0WERUSTFNVEV3T0RFM016SXpPRm9YRFRJMgpNVEV3T0RFM016SXpPRm93R1RFWE1CVUdBMVVFQXd3T1ltRmphMlZ1WkMxamJHbGxiblF3Z2dFaU1BMEdDU3FHClNJYjNEUUVCQVFVQUE0SUJEd0F3Z2dFS0FvSUJBUUN3Nk5LemtqR1BJb0N4N1ZSUTQyNW5kNU1nZmZMZ1BGZDIKbGZLRTdQRCtwUUdiWTNwTW4zUk1Ha2FhSHh6NTlueGhyYjAzZVdUdmZ6YzJEV1hoc2tXRjJxMEFLRGxmbzRyUwptVTREUjVWYktwUS8xdkp5T01TMU1ZQW9yVU9CdzRQTHdGZ2E0c0ZvRXFTV25BWHJwWDcwUHVLOElDV0FWbFN5CmorNUVTTlFYQ0pnRkgzQzF4REFsVWM2ZkhCZTZyWFdlUTMvN2plbnpSK3VneGFQUUl6bERUNE4zUWFuekpxNmQKQUtCZXhWWjJKcGgzb3ZiUVBKbE1RSlpsOWpicThEb3JnOEE5NzBJNHNmWEQzeUFReFhRR3JIdm9FRTJvOHl1RAoyMThZeEJpMzdReXZiT1drcElUY3lybG5sdFJoaGNYZld3UERtMlN1OFpMMHQ3SjRtNTZkQWdNQkFBR2pRakJBCk1CMEdBMVVkRGdRV0JCUWtpZXJidGNidVJzRXJjdjRrZGtnTGY3Y2VOakFmQmdOVkhTTUVHREFXZ0JTUHpsMXUKS2s4WjlYZmszSnNlMktMQnluaWgwVEFOQmdrcWhraUc5dzBCQVFzRkFBT0NBUUVBYmJNOUhwdFhwRndsQU5qdgowZXNZODJqRjhaUWVsK1ZVY1ZhR00wcDlwaTJoZGZoU3A3Ry8xV0RSVEFiVDFKSXYzak1kdEVFdW1MeDlUTnRHCnFEMVUzdkhSdXliSHltUkZURThYUDNDUjJTbEFJcEMvN045N25GRmpGT2EwcEZwRS8weWhkRmpNWkZKUVR0dVAKOXFSNVJSbk9JaXZFSGEwOExXcXlTVml4WUQrY3B1TGFXTm9QVHVIdEM0WVgyenEvMG1yelV1a2RBQWx3anppMwpqd2V2NHNWT3RNWGJXZGhya1lxejBjQ1QrZ1NXbGNsY3FUZEFESFpyZTd5QVFKY1RNV08wMVlycmQ2M2dINUQzCmQ1cWdoOTRTTXdMcExyTkhvaEx2cGRKT01XT0VoV0RiNitaSGZwcnBhUWppMTlaa0JjT0ZTSjQ0aitPZk1IaS8KOGlYNUxRPT0KLS0tLS1FTkQgQ0VSVElGSUNBVEUtLS0tLQo=
            tls.key: LS0tLS1CRUdJTiBQUklWQVRFIEtFWS0tLS0tCk1JSUV2UUlCQURBTkJna3Foa2lHOXcwQkFRRUZBQVNDQktjd2dnU2pBZ0VBQW9JQkFRQ3c2Tkt6a2pHUElvQ3gKN1ZSUTQyNW5kNU1nZmZMZ1BGZDJsZktFN1BEK3BRR2JZM3BNbjNSTUdrYWFIeHo1OW54aHJiMDNlV1R2ZnpjMgpEV1hoc2tXRjJxMEFLRGxmbzRyU21VNERSNVZiS3BRLzF2SnlPTVMxTVlBb3JVT0J3NFBMd0ZnYTRzRm9FcVNXCm5BWHJwWDcwUHVLOElDV0FWbFN5ais1RVNOUVhDSmdGSDNDMXhEQWxVYzZmSEJlNnJYV2VRMy83amVuelIrdWcKeGFQUUl6bERUNE4zUWFuekpxNmRBS0JleFZaMkpwaDNvdmJRUEpsTVFKWmw5amJxOERvcmc4QTk3MEk0c2ZYRAozeUFReFhRR3JIdm9FRTJvOHl1RDIxOFl4QmkzN1F5dmJPV2twSVRjeXJsbmx0UmhoY1hmV3dQRG0yU3U4WkwwCnQ3SjRtNTZkQWdNQkFBRUNnZ0VBSUdDME0yWlZ5SzhWWTdzZWUrRnNFdWE1R0RERTgxSkg1YTNDNFo0bDYwMFMKMHJndHFYbGpoUXdvRU13Ujl4T3NKd3B2djRmcHQ4V09Pc2ZQOWpNMDh5OFhDNWpSQzFaNHNWdWFnaEluWFRTWgpSbWZXSHA2U0xlRmQ1ZFAwTDNzemsyWmtHYU9YcHk4R1RZUkh0eDJtY3hoUlVnSUdLd3RoMi81b3FybXppM1ZhCm1EbXhJQ1hwSm1LK25ITzNUM0R3SXZhUWFGa0JydmkrQWxXNDRFVjkxdzBUcUdGK29VVmVTVzhCUHJmVUJvQkQKZ1JDVGdpQ09FVDFHV0UveVRyZ01RUEdUajlnQ2FJQzVRNFhkejFOS00yT2hIUzlER0dWTElHcDMrT0pQWjdaNwprbmNuZWJFbG5VU0RYenAvRHNxcENqaGQwSEliLzhNbnFLOWhQNkVFUVFLQmdRRGttNTZjQkZxa2hWYlBNYldhCnNOSG10UmUxMG9uYjg5dG8zdDArVUlWa3lpZzQ0YU9jcDFkMDF2WlhSTmxtbjRNdUNWbmVVR1dJVkRzdTBtNGQKUUgvUDhQSXZjY2FPTnpsT2c4cjZFOGIra3RkVWw0ZUQwMEJXeXpiRTJxSGRSN3h0azlqZTFSMW5xMFZrM1RlMgpFRjY4NThRbUlOcTZRMWpONEp6WkFLeU1ZUUtCZ1FER0cyUmFCQ1hwMDcxaFdHbS9rb01uUlZEUDVJbk05enJOCmxiT0dhNTd2Kzg2Z3FZR0VGaFFHSTE0TnNCeVAzTEdRN1VFR3hRTUVyZmw3ai9DVk9teEE3aGJVK0JlZmp3eE0KbjBiaWNhSEpVN3g0WG5sWjgyWmVacmNrTW5QNFd6a0RraVVqeEJCZGRacEdpTVlNMTIyVDN1VzNtSHo2S1RIdQpBZU5BaU1IYnZRS0JnRk9PbGRDTXZ0eTNaOTFmVy9Ob2diQURyT0RtVFVFNXhvNTBOd1daeE1mc0kvdDJiYWpLCmVXclpUenppaTF1NUhlZHJ2NDlFYjNmKzRZcmhteUhSKzJWenVmR2hjbU4weDl0c3pIblBWTUtqeFZURDllSTMKQ3FNdXI1d1FGVzJkMUw5d2RLb3Qxd3VYVEV2cmwzdFNURzViZ0JRM21mck90dHk1SmxzaXBlN0JBb0dBQmhzcQpDS3hBRHVqNzJWaEVTaWRWNjR2elpiVUJtbE8wZUVtNDh0ZTJXbWRFZ3ljMldyL2pkaHo0OVNzTWRsS3pGbWg1CnJKKzk3Qk1Bc1pKS05BOU03dU5ueU1DczJib3JBdUdWNmJ6ZTQ3bTFBWERJQk1HLzBnRVFmQWtpRWZHZDNFSlEKNnIxTVU5VWdJRFJ2Qms1TmpsVThkMkEzMmU0VEgrYm0va0k0MTNFQ2dZRUE1R0xWRU81K1JSVlJaZFhURzgwcwo1aHhDR1lkQ1IydUI4SWlmRTI0UTRlWDNoaHJwQk43em53UlQvK1JJM2RYclZ0OThKNCtXMnNETHVaemhBSlNwCnYydXUyVzdGdFh1SUV3TG9YSmR6VzBZSG0vSldJTlAvR0Nkd08vSzc1SGFWYVVpT3pId0F0akVBMXQzS2xzWCsKRThjMjJYVW1ZTG1vL0d0ZXJCZy9BMkE9Ci0tLS0tRU5EIFBSSVZBVEUgS0VZLS0tLS0K

      ingresses:
        - apiVersion: networking.k8s.io/v1
          kind: Ingress
          metadata:
            namespace: default
            name: backend-mtls-ingress
            annotations:
              haproxy.org/server-ssl: "true"
              haproxy.org/server-ca: "backend-mtls-ca"
              haproxy.org/server-crt: "backend-mtls-client-cert"
          spec:
            rules:
              - host: mtls.example.com
                http:
                  paths:
                    - path: /
                      pathType: Prefix
                      backend:
                        service:
                          name: mtls-service
                          port:
                            number: 8443

      services:
        - apiVersion: v1
          kind: Service
          metadata:
            namespace: default
            name: mtls-service
          spec:
            ports:
              - port: 8443

      endpoints:
        - apiVersion: discovery.k8s.io/v1
          kind: EndpointSlice
          metadata:
            name: mtls-service-abc
            namespace: default
            labels:
              kubernetes.io/service-name: mtls-service
          addressType: IPv4
          endpoints:
            - addresses:
                - "10.0.30.100"
              targetRef:
                kind: Pod
                name: mtls-pod-1
          ports:
            - port: 8443
              protocol: TCP

    assertions:
      - type: haproxy_valid
        description: HAProxy configuration must be syntactically valid

      - type: contains
        target: haproxy.cfg
        pattern: "backend ing_default_backend-mtls-ingress_mtls-service_8443"
        description: Backend must be generated

      - type: contains
        target: haproxy.cfg
        pattern: "ssl verify required ca-file.*default-backend-mtls-ca-ca\\.pem"
        description: Server must include CA file for verification

      - type: contains
        target: haproxy.cfg
        pattern: "crt.*default-backend-mtls-client-cert-client\\.pem"
        description: Server must include client certificate

  test-backend-config-snippet:
    description: Backend config snippet injection
    fixtures:
      ingresses:
        - apiVersion: networking.k8s.io/v1
          kind: Ingress
          metadata:
            namespace: default
            name: snippet-ingress
            annotations:
              haproxy.org/backend-config-snippet: |
                stick-table type string len 32 size 100k expire 30m
                stick store-response res.cook(JSESSIONID)
          spec:
            rules:
              - host: snippet.example.com
                http:
                  paths:
                    - path: /
                      pathType: Prefix
                      backend:
                        service:
                          name: snippet-service
                          port:
                            number: 8080
      services:
        - apiVersion: v1
          kind: Service
          metadata:
            namespace: default
            name: snippet-service
          spec:
            ports:
              - port: 8080
      endpoints:
        - apiVersion: discovery.k8s.io/v1
          kind: EndpointSlice
          metadata:
            name: snippet-service-abc
            namespace: default
            labels:
              kubernetes.io/service-name: snippet-service
          addressType: IPv4
          endpoints:
            - addresses:
                - "10.0.29.100"
              targetRef:
                kind: Pod
                name: snippet-pod-1
          ports:
            - port: 8080
              protocol: TCP
    assertions:
      - type: haproxy_valid
        description: HAProxy configuration must be syntactically valid

      - type: contains
        target: haproxy.cfg
        pattern: "backend ing_default_snippet-ingress_snippet-service_8080"
        description: Backend must be generated

      - type: contains
        target: haproxy.cfg
        pattern: "stick-table type string len 32 size 100k expire 30m"
        description: Must include custom backend config snippet

      - type: contains
        target: haproxy.cfg
        pattern: "stick store-response res\\.cook\\(JSESSIONID\\)"
        description: Must include multiline snippet content

  test-send-proxy-protocol:
    description: PROXY protocol for backend connections
    fixtures:
      ingresses:
        - apiVersion: networking.k8s.io/v1
          kind: Ingress
          metadata:
            namespace: default
            name: proxy-ingress
            annotations:
              haproxy.org/send-proxy-protocol: "proxy-v2"
          spec:
            rules:
              - host: proxy.example.com
                http:
                  paths:
                    - path: /
                      pathType: Prefix
                      backend:
                        service:
                          name: proxy-service
                          port:
                            number: 8080
      services:
        - apiVersion: v1
          kind: Service
          metadata:
            namespace: default
            name: proxy-service
          spec:
            ports:
              - port: 8080
      endpoints:
        - apiVersion: discovery.k8s.io/v1
          kind: EndpointSlice
          metadata:
            name: proxy-service-abc
            namespace: default
            labels:
              kubernetes.io/service-name: proxy-service
          addressType: IPv4
          endpoints:
            - addresses:
                - "10.0.27.100"
              targetRef:
                kind: Pod
                name: proxy-pod-1
          ports:
            - port: 8080
              protocol: TCP
    assertions:
      - type: haproxy_valid
        description: HAProxy configuration must be syntactically valid

      - type: contains
        target: haproxy.cfg
        pattern: "backend ing_default_proxy-ingress_proxy-service_8080"
        description: Backend must be generated

      - type: contains
        target: haproxy.cfg
        pattern: "server SRV_1 10.0.27.100:8080 send-proxy-v2 check"
        description: Server must include send-proxy-v2 directive

  test-scale-server-slots:
    description: Scale server slots for dynamic backends
    fixtures:
      ingresses:
        - apiVersion: networking.k8s.io/v1
          kind: Ingress
          metadata:
            namespace: default
            name: scale-ingress
            annotations:
              haproxy.org/scale-server-slots: "10"
          spec:
            rules:
              - host: scale.example.com
                http:
                  paths:
                    - path: /
                      pathType: Prefix
                      backend:
                        service:
                          name: scale-service
                          port:
                            number: 8080
      services:
        - apiVersion: v1
          kind: Service
          metadata:
            namespace: default
            name: scale-service
          spec:
            ports:
              - port: 8080
      endpoints:
        - apiVersion: discovery.k8s.io/v1
          kind: EndpointSlice
          metadata:
            name: scale-service-abc
            namespace: default
            labels:
              kubernetes.io/service-name: scale-service
          addressType: IPv4
          endpoints:
            - addresses:
                - "10.0.28.100"
              targetRef:
                kind: Pod
                name: scale-pod-1
          ports:
            - port: 8080
              protocol: TCP
    assertions:
      - type: haproxy_valid
        description: HAProxy configuration must be syntactically valid

      - type: contains
        target: haproxy.cfg
        pattern: "backend ing_default_scale-ingress_scale-service_8080"
        description: Backend must be generated

      - type: contains
        target: haproxy.cfg
        pattern: "server SRV_1 10.0.28.100:8080"
        description: First server slot must use active endpoint

      - type: contains
        target: haproxy.cfg
        pattern: "server SRV_10 127.0.0.1:1 disabled"
        description: Last (10th) server slot must be disabled placeholder

      - type: contains
        target: haproxy.cfg
        pattern: "server SRV_2 127.0.0.1:1 disabled"
        description: Remaining server slots must be disabled placeholders

  test-pod-maxconn-zero-pods:
    description: pod-maxconn with zero HAProxy pods (fallback to full value)
    fixtures:
      ingresses:
        - apiVersion: networking.k8s.io/v1
          kind: Ingress
          metadata:
            namespace: default
            name: maxconn-ingress
            annotations:
              haproxy.org/pod-maxconn: "100"
          spec:
            rules:
              - host: maxconn.example.com
                http:
                  paths:
                    - path: /
                      pathType: Prefix
                      backend:
                        service:
                          name: maxconn-service
                          port:
                            number: 8080
      services:
        - apiVersion: v1
          kind: Service
          metadata:
            namespace: default
            name: maxconn-service
          spec:
            ports:
              - port: 8080
      endpoints:
        - apiVersion: discovery.k8s.io/v1
          kind: EndpointSlice
          metadata:
            name: maxconn-service-abc
            namespace: default
            labels:
              kubernetes.io/service-name: maxconn-service
          addressType: IPv4
          endpoints:
            - addresses:
                - "10.0.30.100"
              targetRef:
                kind: Pod
                name: maxconn-pod-1
          ports:
            - port: 8080
              protocol: TCP
      # No haproxy-pods - tests fallback behavior
    assertions:
      - type: haproxy_valid
        description: HAProxy configuration must be syntactically valid

      - type: contains
        target: haproxy.cfg
        pattern: "# pod-maxconn: 100 \\(no HAProxy pods discovered yet, using full value\\)"
        description: Comment shows fallback to full value when no pods

      - type: contains
        target: haproxy.cfg
        pattern: "server SRV_1 10\\.0\\.30\\.100:8080 maxconn 100 check"
        description: Server must have maxconn 100 (full value, no division)

  test-pod-maxconn-single-pod:
    description: pod-maxconn with single HAProxy pod (no division needed)
    fixtures:
      ingresses:
        - apiVersion: networking.k8s.io/v1
          kind: Ingress
          metadata:
            namespace: default
            name: maxconn-ingress
            annotations:
              haproxy.org/pod-maxconn: "100"
          spec:
            rules:
              - host: maxconn.example.com
                http:
                  paths:
                    - path: /
                      pathType: Prefix
                      backend:
                        service:
                          name: maxconn-service
                          port:
                            number: 8080
      services:
        - apiVersion: v1
          kind: Service
          metadata:
            namespace: default
            name: maxconn-service
          spec:
            ports:
              - port: 8080
      endpoints:
        - apiVersion: discovery.k8s.io/v1
          kind: EndpointSlice
          metadata:
            name: maxconn-service-abc
            namespace: default
            labels:
              kubernetes.io/service-name: maxconn-service
          addressType: IPv4
          endpoints:
            - addresses:
                - "10.0.30.100"
              targetRef:
                kind: Pod
                name: maxconn-pod-1
          ports:
            - port: 8080
              protocol: TCP
      haproxy-pods:
        - apiVersion: v1
          kind: Pod
          metadata:
            namespace: haproxy-template-ic
            name: haproxy-pod-1
            labels:
              app: haproxy-template-ic
          status:
            phase: Running
    assertions:
      - type: haproxy_valid
        description: HAProxy configuration must be syntactically valid

      - type: contains
        target: haproxy.cfg
        pattern: "# pod-maxconn: 100 total / 1 HAProxy pods = 100 per pod"
        description: Comment shows calculation with single pod

      - type: contains
        target: haproxy.cfg
        pattern: "server SRV_1 10\\.0\\.30\\.100:8080 maxconn 100 check"
        description: Server must have maxconn 100 (100/1 = 100)

  test-pod-maxconn-multi-pod:
    description: pod-maxconn with multiple HAProxy pods (division required)
    fixtures:
      ingresses:
        - apiVersion: networking.k8s.io/v1
          kind: Ingress
          metadata:
            namespace: default
            name: maxconn-ingress
            annotations:
              haproxy.org/pod-maxconn: "100"
          spec:
            rules:
              - host: maxconn.example.com
                http:
                  paths:
                    - path: /
                      pathType: Prefix
                      backend:
                        service:
                          name: maxconn-service
                          port:
                            number: 8080
      services:
        - apiVersion: v1
          kind: Service
          metadata:
            namespace: default
            name: maxconn-service
          spec:
            ports:
              - port: 8080
      endpoints:
        - apiVersion: discovery.k8s.io/v1
          kind: EndpointSlice
          metadata:
            name: maxconn-service-abc
            namespace: default
            labels:
              kubernetes.io/service-name: maxconn-service
          addressType: IPv4
          endpoints:
            - addresses:
                - "10.0.30.100"
              targetRef:
                kind: Pod
                name: maxconn-pod-1
          ports:
            - port: 8080
              protocol: TCP
      haproxy-pods:
        - apiVersion: v1
          kind: Pod
          metadata:
            namespace: haproxy-template-ic
            name: haproxy-pod-1
            labels:
              app: haproxy-template-ic
          status:
            phase: Running
        - apiVersion: v1
          kind: Pod
          metadata:
            namespace: haproxy-template-ic
            name: haproxy-pod-2
            labels:
              app: haproxy-template-ic
          status:
            phase: Running
    assertions:
      - type: haproxy_valid
        description: HAProxy configuration must be syntactically valid

      - type: contains
        target: haproxy.cfg
        pattern: "# pod-maxconn: 100 total / 2 HAProxy pods = 50 per pod"
        description: Comment shows calculation with 2 pods

      - type: contains
        target: haproxy.cfg
        pattern: "server SRV_1 10\\.0\\.30\\.100:8080 maxconn 50 check"
        description: Server must have maxconn 50 (100/2 = 50)

  test-pod-maxconn-rounding:
    description: pod-maxconn with uneven division (ceiling rounding)
    fixtures:
      ingresses:
        - apiVersion: networking.k8s.io/v1
          kind: Ingress
          metadata:
            namespace: default
            name: maxconn-ingress
            annotations:
              haproxy.org/pod-maxconn: "100"
          spec:
            rules:
              - host: maxconn.example.com
                http:
                  paths:
                    - path: /
                      pathType: Prefix
                      backend:
                        service:
                          name: maxconn-service
                          port:
                            number: 8080
      services:
        - apiVersion: v1
          kind: Service
          metadata:
            namespace: default
            name: maxconn-service
          spec:
            ports:
              - port: 8080
      endpoints:
        - apiVersion: discovery.k8s.io/v1
          kind: EndpointSlice
          metadata:
            name: maxconn-service-abc
            namespace: default
            labels:
              kubernetes.io/service-name: maxconn-service
          addressType: IPv4
          endpoints:
            - addresses:
                - "10.0.30.100"
              targetRef:
                kind: Pod
                name: maxconn-pod-1
          ports:
            - port: 8080
              protocol: TCP
      haproxy-pods:
        - apiVersion: v1
          kind: Pod
          metadata:
            namespace: haproxy-template-ic
            name: haproxy-pod-1
            labels:
              app: haproxy-template-ic
          status:
            phase: Running
        - apiVersion: v1
          kind: Pod
          metadata:
            namespace: haproxy-template-ic
            name: haproxy-pod-2
            labels:
              app: haproxy-template-ic
          status:
            phase: Running
        - apiVersion: v1
          kind: Pod
          metadata:
            namespace: haproxy-template-ic
            name: haproxy-pod-3
            labels:
              app: haproxy-template-ic
          status:
            phase: Running
    assertions:
      - type: haproxy_valid
        description: HAProxy configuration must be syntactically valid

      - type: contains
        target: haproxy.cfg
        pattern: "# pod-maxconn: 100 total / 3 HAProxy pods = 34 per pod"
        description: Comment shows calculation with ceiling rounding (100/3=33.33  34)

      - type: contains
        target: haproxy.cfg
        pattern: "server SRV_1 10\\.0\\.30\\.100:8080 maxconn 34 check"
        description: Server must have maxconn 34 (ceiling of 100/3 = 33.33)

  test-pod-maxconn-minimum:
    description: pod-maxconn minimum value protection (1 connection / 10 pods = 1 minimum)
    fixtures:
      ingresses:
        - apiVersion: networking.k8s.io/v1
          kind: Ingress
          metadata:
            namespace: default
            name: maxconn-ingress
            annotations:
              haproxy.org/pod-maxconn: "1"
          spec:
            rules:
              - host: maxconn.example.com
                http:
                  paths:
                    - path: /
                      pathType: Prefix
                      backend:
                        service:
                          name: maxconn-service
                          port:
                            number: 8080
      services:
        - apiVersion: v1
          kind: Service
          metadata:
            namespace: default
            name: maxconn-service
          spec:
            ports:
              - port: 8080
      endpoints:
        - apiVersion: discovery.k8s.io/v1
          kind: EndpointSlice
          metadata:
            name: maxconn-service-abc
            namespace: default
            labels:
              kubernetes.io/service-name: maxconn-service
          addressType: IPv4
          endpoints:
            - addresses:
                - "10.0.30.100"
              targetRef:
                kind: Pod
                name: maxconn-pod-1
          ports:
            - port: 8080
              protocol: TCP
      haproxy-pods:
        - apiVersion: v1
          kind: Pod
          metadata:
            namespace: haproxy-template-ic
            name: haproxy-pod-1
            labels:
              app: haproxy-template-ic
          status:
            phase: Running
        - apiVersion: v1
          kind: Pod
          metadata:
            namespace: haproxy-template-ic
            name: haproxy-pod-2
            labels:
              app: haproxy-template-ic
          status:
            phase: Running
        - apiVersion: v1
          kind: Pod
          metadata:
            namespace: haproxy-template-ic
            name: haproxy-pod-3
            labels:
              app: haproxy-template-ic
          status:
            phase: Running
        - apiVersion: v1
          kind: Pod
          metadata:
            namespace: haproxy-template-ic
            name: haproxy-pod-4
            labels:
              app: haproxy-template-ic
          status:
            phase: Running
        - apiVersion: v1
          kind: Pod
          metadata:
            namespace: haproxy-template-ic
            name: haproxy-pod-5
            labels:
              app: haproxy-template-ic
          status:
            phase: Running
        - apiVersion: v1
          kind: Pod
          metadata:
            namespace: haproxy-template-ic
            name: haproxy-pod-6
            labels:
              app: haproxy-template-ic
          status:
            phase: Running
        - apiVersion: v1
          kind: Pod
          metadata:
            namespace: haproxy-template-ic
            name: haproxy-pod-7
            labels:
              app: haproxy-template-ic
          status:
            phase: Running
        - apiVersion: v1
          kind: Pod
          metadata:
            namespace: haproxy-template-ic
            name: haproxy-pod-8
            labels:
              app: haproxy-template-ic
          status:
            phase: Running
        - apiVersion: v1
          kind: Pod
          metadata:
            namespace: haproxy-template-ic
            name: haproxy-pod-9
            labels:
              app: haproxy-template-ic
          status:
            phase: Running
        - apiVersion: v1
          kind: Pod
          metadata:
            namespace: haproxy-template-ic
            name: haproxy-pod-10
            labels:
              app: haproxy-template-ic
          status:
            phase: Running
    assertions:
      - type: haproxy_valid
        description: HAProxy configuration must be syntactically valid

      - type: contains
        target: haproxy.cfg
        pattern: "# pod-maxconn: 1 total / 10 HAProxy pods = 1 per pod"
        description: Comment shows minimum value protection (1/10=0.1  1)

      - type: contains
        target: haproxy.cfg
        pattern: "server SRV_1 10\\.0\\.30\\.100:8080 maxconn 1 check"
        description: Server must have maxconn 1 (minimum enforced by ceiling rounding)

  test-empty-annotations-bool-error:
    description: Ingress with empty annotations should not cause Bool() errors
    fixtures:
      ingresses:
        - apiVersion: networking.k8s.io/v1
          kind: Ingress
          metadata:
            namespace: default
            name: empty-annotations-ingress
            annotations: {}
          spec:
            rules:
              - host: empty.example.com
                http:
                  paths:
                    - path: /
                      pathType: Prefix
                      backend:
                        service:
                          name: test-service
                          port:
                            number: 80
      services:
        - apiVersion: v1
          kind: Service
          metadata:
            namespace: default
            name: test-service
          spec:
            ports:
              - port: 80
      endpoints:
        - apiVersion: discovery.k8s.io/v1
          kind: EndpointSlice
          metadata:
            name: test-service-abc
            namespace: default
            labels:
              kubernetes.io/service-name: test-service
          addressType: IPv4
          endpoints:
            - addresses:
                - "10.0.30.100"
              targetRef:
                kind: Pod
                name: test-pod-1
          ports:
            - port: 8080
              protocol: TCP
    assertions:
      - type: haproxy_valid
        description: HAProxy configuration must be valid despite empty annotations

      - type: contains
        target: haproxy.cfg
        pattern: "backend ing_default_empty-annotations-ingress_test-service_80"
        description: Backend must be created for ingress with empty annotations

  test-ssl-passthrough-basic:
    _helm_skip_test: "{{ not .Values.controller.templateLibraries.ssl.enabled }}"
    description: SSL passthrough with basic configuration
    fixtures:
      ingresses:
        - apiVersion: networking.k8s.io/v1
          kind: Ingress
          metadata:
            namespace: default
            name: ssl-passthrough-ingress
            annotations:
              haproxy.org/ssl-passthrough: "true"
          spec:
            rules:
              - host: secure.example.com
                http:
                  paths:
                    - path: /
                      pathType: Prefix
                      backend:
                        service:
                          name: secure-service
                          port:
                            number: 443
      services:
        - apiVersion: v1
          kind: Service
          metadata:
            namespace: default
            name: secure-service
          spec:
            ports:
              - port: 443
      endpoints:
        - apiVersion: discovery.k8s.io/v1
          kind: EndpointSlice
          metadata:
            name: secure-service-abc
            namespace: default
            labels:
              kubernetes.io/service-name: secure-service
          addressType: IPv4
          endpoints:
            - addresses:
                - "10.0.1.30"
          ports:
            - port: 8443
              protocol: TCP
      secrets:
        - apiVersion: v1
          kind: Secret
          metadata:
            name: default-ssl-cert
            namespace: haproxy-template-ic
          type: kubernetes.io/tls
          data:
            tls.crt: LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSURPRENDQWlDZ0F3SUJBZ0lVZWhzTG4zZXdrWXYzcDArb0RRREp5clNVeUVJd0RRWUpLb1pJaHZjTkFRRUwKQlFBd0dERVdNQlFHQTFVRUF3d05LaTVsZUdGdGNHeGxMbU52YlRBZUZ3MHlOVEV4TVRneU1USTJNalphRncweQpOakV4TVRneU1USTJNalphTUJneEZqQVVCZ05WQkFNTURTb3VaWGhoYlhCc1pTNWpiMjB3Z2dFaU1BMEdDU3FHClNJYjNEUUVCQVFVQUE0SUJEd0F3Z2dFS0FvSUJBUUNISGNYaW16Kys3U0FBSkFpOEloTWNyQ2VDWW9PaWRXNW4KS3BHbTE0NjNyTU0vSnJ0YmtlajdlK1kwYWVwL0xyTUlPT2ZSVGpWTEo5RVcrdFFuQWJGajVzcHJ0WWtFMkdvNwpWU0c3aXh5L2VYcTQ5VFdRd0E4YTJkT2dJQ3daTWM3OGlZMGI5T2tQc3MxUUJxajNMbSsvV3FDOTNzSU1Xc3VrCkZqZW5xdEp1Y2ZhdzZ4VUc2YXZXVE15WUtMenB4SGtEbUt6dEJodlJDMjhoOVZNSytDZzJTeXpyWUhOQkJWRSsKZlF3NCtxdWZFRi8zT0sxVnQvL1BJcWpGclhXd3FFajRJRTMvMW0wcVZJMWtzTnFvSW5hR2NUTzJDWjBzT29LWApsUkJuSkZwc1ZzcUk0SU9uMHNHYTQ4WFFIbDJFR3o4STZuVzVMS3dOcUg0eUlaTWt3VkhYQWdNQkFBR2plakI0Ck1CMEdBMVVkRGdRV0JCU2tQZ0crUEFSVG5vdmRpem45RHhISldYNXNJREFmQmdOVkhTTUVHREFXZ0JTa1BnRysKUEFSVG5vdmRpem45RHhISldYNXNJREFQQmdOVkhSTUJBZjhFQlRBREFRSC9NQ1VHQTFVZEVRUWVNQnlDRFNvdQpaWGhoYlhCc1pTNWpiMjJDQzJWNFlXMXdiR1V1WTI5dE1BMEdDU3FHU0liM0RRRUJDd1VBQTRJQkFRQVJ0SFFCCnA2NFNJb0hWbWFMTldtVy9nNE9JdE4rTGFCQUp3VDZtR0ZGWEtGdkxEVm5aSkdKS20xMmI2QzRaUmRCM3dteXIKTFV0MTYyeDIzcjRUdy9LNytFQ1NuajFUcVlyM25qR0JlRGRHV3ZPZkpwSTBWMFZWNm9CdkxPNUdGN3cxd1MvbApaeWs0R1VQamJ5TVpiRElTWUJnYk1xU1lTbzJ1eHpKMW9CMTRxaE9uS2lWYUNJUzUwZ2FVZ2Zhd2VlMndPT2tQCktrUG9BUUlya2hTZGlXOVpsSWt3ZksrTWd3Q2IwbWp2M05NTy9wYWxnc2Y0SGpLVy8wTnlkVDZZRXA2eXhES1IKMmxGTHEybDJRZjgvcEp0MFlUaXdPMjVSNTV0S2k2UFRjUkFmRjcrMzdEN3B2TlNaaW53V0d0dkJrRytZdjN2agppZ1oxbGxOTlN4T2VDNjVTCi0tLS0tRU5EIENFUlRJRklDQVRFLS0tLS0K
            tls.key: LS0tLS1CRUdJTiBQUklWQVRFIEtFWS0tLS0tCk1JSUV2QUlCQURBTkJna3Foa2lHOXcwQkFRRUZBQVNDQktZd2dnU2lBZ0VBQW9JQkFRQ0hIY1hpbXorKzdTQUEKSkFpOEloTWNyQ2VDWW9PaWRXNW5LcEdtMTQ2M3JNTS9KcnRia2VqN2UrWTBhZXAvTHJNSU9PZlJUalZMSjlFVwordFFuQWJGajVzcHJ0WWtFMkdvN1ZTRzdpeHkvZVhxNDlUV1F3QThhMmRPZ0lDd1pNYzc4aVkwYjlPa1BzczFRCkJxajNMbSsvV3FDOTNzSU1Xc3VrRmplbnF0SnVjZmF3NnhVRzZhdldUTXlZS0x6cHhIa0RtS3p0Qmh2UkMyOGgKOVZNSytDZzJTeXpyWUhOQkJWRStmUXc0K3F1ZkVGLzNPSzFWdC8vUElxakZyWFd3cUVqNElFMy8xbTBxVkkxawpzTnFvSW5hR2NUTzJDWjBzT29LWGxSQm5KRnBzVnNxSTRJT24wc0dhNDhYUUhsMkVHejhJNm5XNUxLd05xSDR5CklaTWt3VkhYQWdNQkFBRUNnZ0VBS0NJNVZhcU1vRDhaK3NDNVVYeURsY2d6QWlFVi9Zc0pESjdSM2E5NGhtbE0KSTNWelFHdFNPMlRkaDZNUVVzL0J3UWI2SUtzczNGS0s0bHNGNmtJditUOGowQ04vZkE5MldvSmFmelQraUlkaQpZdzcrNXF5TnNBbVV1U0xsUm1TTG1XcVlIZjQ4dmZ0N3piSDB2VnN2T1RVSHV1NHdVSEFsdmVzVmcvbVRBTmZ0Cmk4eWp0UWExMWxFZEhiZUc0NVEya1dkRGdmc0hSaENwKzFaK3YyYkdnYllzY25BdGNlSjJxTnZGU0Zoc3REakQKNXhWMzFpUjBXRnNITmVoU0FyalZNSDk3QldGempPa1RxdFhLOUgvODJFaHIzNzlzVGNCQU5FSnphMENMdnBQMgpHaTBmS0M3R3FOeElXM1oweGVlY0tMVE1qRHExUjk0c2tkdUk2MlVjUFFLQmdRQytwM1VYRHhsMFF3OHdTaFFPCkFUMzJYbE9qQktzREN3c21KUzZaeTlCbjRNKzdKdWs1VjQvL04xM0drTDVVUm5BcWxQMWFzQ1A4bDhPdG9oR0cKOTJ0TUdkVldvdjhrbVpFVzRzNW9mOForZHBwc09XWjlJY3licG5Ec2tXMzdvQTFtNE1maUJydzRMWVJZcmlZTwo4RUlJOC9oc1ZxNEVaMnRhRlFHbHQwcmViUUtCZ1FDMWJVUTFxb0hwbHkvQjBEVEFCQjc4UGk3TG1KQWFzdVRSCnJVRHlMWWhzak9RR0p5cmF3SUJYRjkweHJma3FrTmlMZjBPSlcvWjNWeUFTdys0WmlzSkFwbGN0TU5HclFlamcKTy83REthZkZzTldJMElRQ2UyYUlISVlMbWcrU2ZFNnhlWU5kak5ZeEtmTUtpQWQzZW5TeE9uSU12T0lscU1pNwpKTWlmU3dVMjB3S0JnRVArbXY3UFRzZXRCdVMwOXJRTDgxcERSOWJTMmw2cWVKNXhFazZkWnNVMVkwQ2UzdnlwCll0eWxsVmMwMWZ4ZVpyQjVGR1pjZldrZmd4VVF3T2wrb2hDeEFlbjFGY09xMVJqeGFLWFNOQ3QwQnh6ajE4NTIKMkc4R2pDMkNyRlBhUUExWnkwK3NFVUtEMFRpRFcyVm1nRmFMRkNVblFNYW5UNXovOHVkMEdFcDlBb0dBTVFzYwppVFZTY1FiQmppN3VVNG5KcG41WXdBaTV5NzNZUlNZRWpITHFrZzEwQm9YSCsrSlZ6elZRUWdHNWZWd3liV00xCnFvZ0ZsRFVsSW0xOGk4TUt4OWN2Y2JQa3VkclRUT3BxNys3dXYyNFNDeTN5d1lrQ0tvRXJheTkyVGk3MFJ0MkcKT1YrODl3VlVBZURMdyt5Q1p2Wlpwai9aRWowU0ppVEhadWdzdktrQ2dZQmlYTUxXZkpnTnRSTytURDR6T091RQorZ1dIM2JvZlNXcjFCeGJaOHdLdC8xVUZLdU9QaXdqNUJMUWpoZnpMbS9IeU5RYnhGNVNXQXNCL3BBTUF5bnFqCnZ6MVEvSnUzZi9PWkxtdGE2OFRCcUdsZjRzaGpZK2dkaUZzYmtBRkdIbUlvbGFvMHZhcXdvNVN4S3Q2RWVoeTIKRi8yR0dZMTI3Nm1PUzZWcVZMaml2Zz09Ci0tLS0tRU5EIFBSSVZBVEUgS0VZLS0tLS0K
    assertions:
      - type: haproxy_valid
        description: HAProxy configuration must be syntactically valid

      - type: contains
        target: haproxy.cfg
        pattern: "frontend ssl-tcp"
        description: Must generate TCP frontend for SSL passthrough

      - type: contains
        target: haproxy.cfg
        pattern: "mode tcp"
        description: TCP frontend must be in TCP mode

      - type: contains
        target: haproxy.cfg
        pattern: "bind \\*:8443"
        description: TCP frontend must bind to port 8443

      - type: contains
        target: haproxy.cfg
        pattern: "tcp-request inspect-delay 5s"
        description: Must wait for SSL client hello

      - type: contains
        target: haproxy.cfg
        pattern: "tcp-request content accept if \\{ req_ssl_hello_type 1 \\}"
        description: Must accept SSL client hello

      - type: contains
        target: haproxy.cfg
        pattern: "use_backend ssl-passthrough-default-ssl-passthrough-ingress if \\{ req_ssl_sni -m str secure\\.example\\.com \\}"
        description: Must route based on SNI to passthrough backend

      - type: contains
        target: haproxy.cfg
        pattern: "default_backend ssl-loopback"
        description: Must default to loopback backend for SSL termination

      - type: contains
        target: haproxy.cfg
        pattern: "backend ssl-passthrough-default-ssl-passthrough-ingress"
        description: Must generate passthrough backend

      - type: contains
        target: haproxy.cfg
        pattern: "backend ssl-loopback"
        description: Must generate loopback backend

      - type: contains
        target: haproxy.cfg
        pattern: "server loopback unix@/etc/haproxy/ssl-frontend\\.sock send-proxy-v2"
        description: Loopback must use unix socket with PROXY protocol v2

      - type: contains
        target: haproxy.cfg
        pattern: "frontend https"
        description: Must generate HTTPS frontend on unix socket

      - type: contains
        target: haproxy.cfg
        pattern: "bind unix@/etc/haproxy/ssl-frontend\\.sock mode 660 ssl crt-list .*certificate-list\\.txt alpn h2,http/1\\.1 accept-proxy"
        description: HTTPS frontend must terminate SSL and accept PROXY protocol

  test-ssl-passthrough-no-annotation:
    _helm_skip_test: "{{ not .Values.controller.templateLibraries.ssl.enabled }}"
    description: No SSL passthrough frontends when annotation not present
    fixtures:
      ingresses:
        - apiVersion: networking.k8s.io/v1
          kind: Ingress
          metadata:
            namespace: default
            name: normal-ingress
          spec:
            rules:
              - host: normal.example.com
                http:
                  paths:
                    - path: /
                      pathType: Prefix
                      backend:
                        service:
                          name: normal-service
                          port:
                            number: 80
      services:
        - apiVersion: v1
          kind: Service
          metadata:
            namespace: default
            name: normal-service
          spec:
            ports:
              - port: 80
      endpoints:
        - apiVersion: discovery.k8s.io/v1
          kind: EndpointSlice
          metadata:
            name: normal-service-abc
            namespace: default
            labels:
              kubernetes.io/service-name: normal-service
          addressType: IPv4
          endpoints:
            - addresses:
                - "10.0.1.60"
          ports:
            - port: 8080
              protocol: TCP
      secrets:
        - apiVersion: v1
          kind: Secret
          metadata:
            name: default-ssl-cert
            namespace: haproxy-template-ic
          type: kubernetes.io/tls
          data:
            tls.crt: LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSURPRENDQWlDZ0F3SUJBZ0lVZWhzTG4zZXdrWXYzcDArb0RRREp5clNVeUVJd0RRWUpLb1pJaHZjTkFRRUwKQlFBd0dERVdNQlFHQTFVRUF3d05LaTVsZUdGdGNHeGxMbU52YlRBZUZ3MHlOVEV4TVRneU1USTJNalphRncweQpOakV4TVRneU1USTJNalphTUJneEZqQVVCZ05WQkFNTURTb3VaWGhoYlhCc1pTNWpiMjB3Z2dFaU1BMEdDU3FHClNJYjNEUUVCQVFVQUE0SUJEd0F3Z2dFS0FvSUJBUUNISGNYaW16Kys3U0FBSkFpOEloTWNyQ2VDWW9PaWRXNW4KS3BHbTE0NjNyTU0vSnJ0YmtlajdlK1kwYWVwL0xyTUlPT2ZSVGpWTEo5RVcrdFFuQWJGajVzcHJ0WWtFMkdvNwpWU0c3aXh5L2VYcTQ5VFdRd0E4YTJkT2dJQ3daTWM3OGlZMGI5T2tQc3MxUUJxajNMbSsvV3FDOTNzSU1Xc3VrCkZqZW5xdEp1Y2ZhdzZ4VUc2YXZXVE15WUtMenB4SGtEbUt6dEJodlJDMjhoOVZNSytDZzJTeXpyWUhOQkJWRSsKZlF3NCtxdWZFRi8zT0sxVnQvL1BJcWpGclhXd3FFajRJRTMvMW0wcVZJMWtzTnFvSW5hR2NUTzJDWjBzT29LWApsUkJuSkZwc1ZzcUk0SU9uMHNHYTQ4WFFIbDJFR3o4STZuVzVMS3dOcUg0eUlaTWt3VkhYQWdNQkFBR2plakI0Ck1CMEdBMVVkRGdRV0JCU2tQZ0crUEFSVG5vdmRpem45RHhISldYNXNJREFmQmdOVkhTTUVHREFXZ0JTa1BnRysKUEFSVG5vdmRpem45RHhISldYNXNJREFQQmdOVkhSTUJBZjhFQlRBREFRSC9NQ1VHQTFVZEVRUWVNQnlDRFNvdQpaWGhoYlhCc1pTNWpiMjJDQzJWNFlXMXdiR1V1WTI5dE1BMEdDU3FHU0liM0RRRUJDd1VBQTRJQkFRQVJ0SFFCCnA2NFNJb0hWbWFMTldtVy9nNE9JdE4rTGFCQUp3VDZtR0ZGWEtGdkxEVm5aSkdKS20xMmI2QzRaUmRCM3dteXIKTFV0MTYyeDIzcjRUdy9LNytFQ1NuajFUcVlyM25qR0JlRGRHV3ZPZkpwSTBWMFZWNm9CdkxPNUdGN3cxd1MvbApaeWs0R1VQamJ5TVpiRElTWUJnYk1xU1lTbzJ1eHpKMW9CMTRxaE9uS2lWYUNJUzUwZ2FVZ2Zhd2VlMndPT2tQCktrUG9BUUlya2hTZGlXOVpsSWt3ZksrTWd3Q2IwbWp2M05NTy9wYWxnc2Y0SGpLVy8wTnlkVDZZRXA2eXhES1IKMmxGTHEybDJRZjgvcEp0MFlUaXdPMjVSNTV0S2k2UFRjUkFmRjcrMzdEN3B2TlNaaW53V0d0dkJrRytZdjN2agppZ1oxbGxOTlN4T2VDNjVTCi0tLS0tRU5EIENFUlRJRklDQVRFLS0tLS0K
            tls.key: LS0tLS1CRUdJTiBQUklWQVRFIEtFWS0tLS0tCk1JSUV2QUlCQURBTkJna3Foa2lHOXcwQkFRRUZBQVNDQktZd2dnU2lBZ0VBQW9JQkFRQ0hIY1hpbXorKzdTQUEKSkFpOEloTWNyQ2VDWW9PaWRXNW5LcEdtMTQ2M3JNTS9KcnRia2VqN2UrWTBhZXAvTHJNSU9PZlJUalZMSjlFVwordFFuQWJGajVzcHJ0WWtFMkdvN1ZTRzdpeHkvZVhxNDlUV1F3QThhMmRPZ0lDd1pNYzc4aVkwYjlPa1BzczFRCkJxajNMbSsvV3FDOTNzSU1Xc3VrRmplbnF0SnVjZmF3NnhVRzZhdldUTXlZS0x6cHhIa0RtS3p0Qmh2UkMyOGgKOVZNSytDZzJTeXpyWUhOQkJWRStmUXc0K3F1ZkVGLzNPSzFWdC8vUElxakZyWFd3cUVqNElFMy8xbTBxVkkxawpzTnFvSW5hR2NUTzJDWjBzT29LWGxSQm5KRnBzVnNxSTRJT24wc0dhNDhYUUhsMkVHejhJNm5XNUxLd05xSDR5CklaTWt3VkhYQWdNQkFBRUNnZ0VBS0NJNVZhcU1vRDhaK3NDNVVYeURsY2d6QWlFVi9Zc0pESjdSM2E5NGhtbE0KSTNWelFHdFNPMlRkaDZNUVVzL0J3UWI2SUtzczNGS0s0bHNGNmtJditUOGowQ04vZkE5MldvSmFmelQraUlkaQpZdzcrNXF5TnNBbVV1U0xsUm1TTG1XcVlIZjQ4dmZ0N3piSDB2VnN2T1RVSHV1NHdVSEFsdmVzVmcvbVRBTmZ0Cmk4eWp0UWExMWxFZEhiZUc0NVEya1dkRGdmc0hSaENwKzFaK3YyYkdnYllzY25BdGNlSjJxTnZGU0Zoc3REakQKNXhWMzFpUjBXRnNITmVoU0FyalZNSDk3QldGempPa1RxdFhLOUgvODJFaHIzNzlzVGNCQU5FSnphMENMdnBQMgpHaTBmS0M3R3FOeElXM1oweGVlY0tMVE1qRHExUjk0c2tkdUk2MlVjUFFLQmdRQytwM1VYRHhsMFF3OHdTaFFPCkFUMzJYbE9qQktzREN3c21KUzZaeTlCbjRNKzdKdWs1VjQvL04xM0drTDVVUm5BcWxQMWFzQ1A4bDhPdG9oR0cKOTJ0TUdkVldvdjhrbVpFVzRzNW9mOForZHBwc09XWjlJY3licG5Ec2tXMzdvQTFtNE1maUJydzRMWVJZcmlZTwo4RUlJOC9oc1ZxNEVaMnRhRlFHbHQwcmViUUtCZ1FDMWJVUTFxb0hwbHkvQjBEVEFCQjc4UGk3TG1KQWFzdVRSCnJVRHlMWWhzak9RR0p5cmF3SUJYRjkweHJma3FrTmlMZjBPSlcvWjNWeUFTdys0WmlzSkFwbGN0TU5HclFlamcKTy83REthZkZzTldJMElRQ2UyYUlISVlMbWcrU2ZFNnhlWU5kak5ZeEtmTUtpQWQzZW5TeE9uSU12T0lscU1pNwpKTWlmU3dVMjB3S0JnRVArbXY3UFRzZXRCdVMwOXJRTDgxcERSOWJTMmw2cWVKNXhFazZkWnNVMVkwQ2UzdnlwCll0eWxsVmMwMWZ4ZVpyQjVGR1pjZldrZmd4VVF3T2wrb2hDeEFlbjFGY09xMVJqeGFLWFNOQ3QwQnh6ajE4NTIKMkc4R2pDMkNyRlBhUUExWnkwK3NFVUtEMFRpRFcyVm1nRmFMRkNVblFNYW5UNXovOHVkMEdFcDlBb0dBTVFzYwppVFZTY1FiQmppN3VVNG5KcG41WXdBaTV5NzNZUlNZRWpITHFrZzEwQm9YSCsrSlZ6elZRUWdHNWZWd3liV00xCnFvZ0ZsRFVsSW0xOGk4TUt4OWN2Y2JQa3VkclRUT3BxNys3dXYyNFNDeTN5d1lrQ0tvRXJheTkyVGk3MFJ0MkcKT1YrODl3VlVBZURMdyt5Q1p2Wlpwai9aRWowU0ppVEhadWdzdktrQ2dZQmlYTUxXZkpnTnRSTytURDR6T091RQorZ1dIM2JvZlNXcjFCeGJaOHdLdC8xVUZLdU9QaXdqNUJMUWpoZnpMbS9IeU5RYnhGNVNXQXNCL3BBTUF5bnFqCnZ6MVEvSnUzZi9PWkxtdGE2OFRCcUdsZjRzaGpZK2dkaUZzYmtBRkdIbUlvbGFvMHZhcXdvNVN4S3Q2RWVoeTIKRi8yR0dZMTI3Nm1PUzZWcVZMaml2Zz09Ci0tLS0tRU5EIFBSSVZBVEUgS0VZLS0tLS0K
    assertions:
      - type: haproxy_valid
        description: HAProxy configuration must be syntactically valid

      - type: not_contains
        target: haproxy.cfg
        pattern: "frontend ssl-tcp"
        description: Must NOT generate TCP frontend when no passthrough annotation

      - type: contains
        target: haproxy.cfg
        pattern: "bind \\*:8443 ssl"
        description: HTTPS frontend must bind to regular port when no passthrough

      - type: not_contains
        target: haproxy.cfg
        pattern: "backend ssl-loopback"
        description: Must NOT generate loopback backend when no passthrough annotation

  test-cookie-persistence-no-dynamic:
    description: Static cookie persistence without dynamic cookie-key
    fixtures:
      ingresses:
        - apiVersion: networking.k8s.io/v1
          kind: Ingress
          metadata:
            namespace: default
            name: static-cookie-ingress
            annotations:
              haproxy.org/cookie-persistence-no-dynamic: "SERVERID"
          spec:
            rules:
              - host: app.example.com
                http:
                  paths:
                    - path: /
                      pathType: Prefix
                      backend:
                        service:
                          name: app-service
                          port:
                            number: 8080
      services:
        - apiVersion: v1
          kind: Service
          metadata:
            namespace: default
            name: app-service
          spec:
            ports:
              - port: 8080
      endpoints:
        - apiVersion: discovery.k8s.io/v1
          kind: EndpointSlice
          metadata:
            name: app-service-xyz
            namespace: default
            labels:
              kubernetes.io/service-name: app-service
          addressType: IPv4
          endpoints:
            - addresses:
                - "10.0.1.20"
          ports:
            - port: 8080
              protocol: TCP
    assertions:
      - type: haproxy_valid
        description: HAProxy configuration must be syntactically valid

      - type: contains
        target: haproxy.cfg
        pattern: "cookie SERVERID insert indirect nocache"
        description: Must generate static cookie directive

      - type: not_contains
        target: haproxy.cfg
        pattern: "dynamic-cookie-key"
        description: Must NOT include dynamic-cookie-key

      - type: not_contains
        target: haproxy.cfg
        pattern: "cookie SERVERID insert indirect nocache dynamic"
        description: Must NOT include dynamic keyword in cookie directive

  test-cookie-persistence-mutual-exclusion:
    description: Cannot use both dynamic and static cookie persistence
    fixtures:
      ingresses:
        - apiVersion: networking.k8s.io/v1
          kind: Ingress
          metadata:
            namespace: default
            name: conflict-ingress
            annotations:
              haproxy.org/cookie-persistence: "SESSION1"
              haproxy.org/cookie-persistence-no-dynamic: "SESSION2"
          spec:
            rules:
              - host: app.example.com
                http:
                  paths:
                    - path: /
                      pathType: Prefix
                      backend:
                        service:
                          name: app-service
                          port:
                            number: 8080
      services:
        - apiVersion: v1
          kind: Service
          metadata:
            namespace: default
            name: app-service
          spec:
            ports:
              - port: 8080
      endpoints:
        - apiVersion: discovery.k8s.io/v1
          kind: EndpointSlice
          metadata:
            name: app-service-xyz
            namespace: default
            labels:
              kubernetes.io/service-name: app-service
          addressType: IPv4
          endpoints:
            - addresses:
                - "10.0.1.20"
          ports:
            - port: 8080
              protocol: TCP
    assertions:
      - type: contains
        target: rendering_error
        pattern: "Cannot use both 'haproxy.org/cookie-persistence' and 'haproxy.org/cookie-persistence-no-dynamic'"
        description: Must fail with clear mutual exclusion error
